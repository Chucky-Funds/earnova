<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earnova | Enterprise Task Dashboard</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Paystack Inline JS -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    
    <style>
        /* ------------------------------------------------------------
           1. CSS VARIABLES & THEME SYSTEM
        ------------------------------------------------------------ */
        :root {
            /* LIGHT THEME DEFAULT */
            --bg-primary: #F9FAFB;
            --bg-secondary: #FFFFFF;
            --sidebar-bg: #FFFFFF;
            --card-bg: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --accent-primary: #1E3A8A;   /* Deep Blue */
            --accent-secondary: #F97316; /* Orange */
            --success: #10B981;
            --danger: #EF4444;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            
            /* Layout Variables */
            --nav-width: 260px;
            --header-height: 70px;
            --container-padding: 32px;
            --border-radius: 12px;
        }

        [data-theme="dark"] {
            --bg-primary: #0F172A;
            --bg-secondary: #111827;
            --sidebar-bg: #0B1220;
            --card-bg: #1E293B;
            --text-primary: #F9FAFB;
            --text-secondary: #94A3B8;
            --border-color: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* --- Video Card: Completed State --- */
        .video-task-card.completed,
        .video-task-card.completed * {
            cursor: not-allowed !important;
            opacity: 0.5;
        }
        
        /* ------------------------------------------------------------
           2. RESET & BASE STYLES
        ------------------------------------------------------------ */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-family); 
            background-color: var(--bg-primary); 
            color: var(--text-primary); 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            font-size: 14px; 
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.2s ease;
        }

        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        button { cursor: pointer; border: none; font-family: inherit; background: none; }
        input, select, textarea { font-family: inherit; }
        img, svg { max-width: 100%; display: block; }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* ------------------------------------------------------------
           3. LAYOUT GRID
        ------------------------------------------------------------ */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
            position: relative;
        }

        /* ------------------------------------------------------------
           4. SIDEBAR (RESPONSIVE)
        ------------------------------------------------------------ */
        .sidebar {
            width: var(--nav-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 24px 16px;
            z-index: 1000;
            height: 100%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            flex-shrink: 0;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
            padding: 0 12px;
            height: 40px;
        }

        .logo-icon {
            width: 32px; height: 32px;
            background: var(--accent-primary);
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 18px;
            flex-shrink: 0;
        }

        .logo-text { font-size: 20px; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; white-space: nowrap; }
        .logo-text span { color: var(--accent-secondary); }

        .nav-content { flex: 1; overflow-y: auto; overflow-x: hidden; }

        .nav-group { margin-bottom: 24px; }
        .nav-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding: 0 12px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-item:hover { background-color: var(--bg-primary); color: var(--text-primary); }
        
        .nav-item.active {
            background-color: rgba(30, 58, 138, 0.08);
            color: var(--accent-primary);
            font-weight: 600;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: -16px; top: 50%; transform: translateY(-50%);
            width: 4px; height: 20px;
            background-color: var(--accent-secondary);
            border-radius: 0 4px 4px 0;
        }

        .nav-icon { width: 20px; height: 20px; margin-right: 12px; flex-shrink: 0; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        /* Overlay for mobile */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 900;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

        /* ------------------------------------------------------------
           5. MAIN CONTENT WRAPPER
        ------------------------------------------------------------ */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            width: 100%;
        }

        /* ------------------------------------------------------------
           6. HEADER
        ------------------------------------------------------------ */
        .header {
            height: var(--header-height);
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--container-padding);
            flex-shrink: 0;
        }

        .header-left { display: flex; align-items: center; gap: 16px; flex: 1; }
        
        .hamburger {
            display: none;
            width: 32px; height: 32px;
            align-items: center; justify-content: center;
            color: var(--text-primary);
        }

        /* --- NEW: Daily Reset Timer Styles --- */
        .daily-reset-timer {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 13px;
            background: var(--bg-primary);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .reset-countdown {
            color: var(--accent-secondary);
            font-variant-numeric: tabular-nums;
            font-weight: 700;
        }

        .header-actions { display: flex; align-items: center; gap: 20px; }

        /* Theme Toggle */
        .theme-toggle {
            width: 48px; height: 26px;
            background-color: var(--border-color);
            border-radius: 50px;
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
        }
        .theme-knob {
            width: 22px; height: 22px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 2px; left: 2px;
            transition: transform 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .theme-icon { width: 12px; height: 12px; color: var(--text-secondary); }
        [data-theme="dark"] .theme-knob { transform: translateX(22px); background-color: var(--bg-secondary); }

        .balance-display {
            display: flex; flex-direction: column; align-items: flex-end;
        }
        .balance-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .balance-amount {
            font-size: 16px; font-weight: 700; color: var(--accent-primary);
            font-feature-settings: "tnum"; white-space: nowrap;
        }
        .balance-amount.flash { color: var(--success); transition: none; }

        .user-profile { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .avatar {
            width: 36px; height: 36px;
            background-color: var(--accent-primary);
            border-radius: 50%;
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 14px;
            border: 2px solid var(--bg-secondary);
            flex-shrink: 0;
        }

        /* ------------------------------------------------------------
           7. MAIN SCROLLABLE AREA
        ------------------------------------------------------------ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--container-padding);
            background-color: var(--bg-primary);
        }

        .content-width-limiter {
            max-width: 1400px;
            margin: 0 auto;
        }

        .section-header { margin-bottom: 24px; }
        .page-title { font-size: 24px; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
        .page-subtitle { color: var(--text-secondary); margin-top: 4px; font-size: 14px; }

        /* GRID SYSTEM */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow);
            display: flex; flex-direction: column;
            position: relative;
        }

        .stat-label { color: var(--text-secondary); font-size: 13px; font-weight: 500; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-top: 8px; word-break: break-all; }
        .stat-trend { font-size: 12px; margin-top: 4px; display: flex; align-items: center; gap: 4px; }
        .trend-up { color: var(--success); }

        /* CHARTS */
        .chart-container {
            position: relative;
            height: 320px;
            width: 100%;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        /* TASKS */
        .task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .task-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex; flex-direction: column;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .task-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        .task-header {
            padding: 16px;
            background-color: rgba(30, 58, 138, 0.05);
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            gap: 8px;
        }

        .task-reward {
            font-weight: 700; color: var(--success); background: rgba(16, 185, 129, 0.1);
            padding: 4px 8px; border-radius: 4px; font-size: 12px;
            white-space: nowrap;
        }

        .task-body { padding: 16px; flex: 1; display: flex; flex-direction: column; }
        .task-title { font-weight: 600; font-size: 16px; margin-bottom: 8px; }
        .task-meta { font-size: 12px; color: var(--text-secondary); display: flex; gap: 12px; margin-bottom: 16px; }

        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-primary { background-color: var(--accent-primary); color: white; }
        .btn-primary:hover { background-color: #172554; }
        .btn-outline { border: 1px solid var(--border-color); color: var(--text-primary); background: transparent; }
        .btn-outline:hover { border-color: var(--text-secondary); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .progress-container {
            width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; overflow: hidden; margin-top: auto; margin-bottom: 12px;
        }
        .progress-bar { height: 100%; background: var(--accent-secondary); width: 0%; transition: width 0.3s linear; }

        /* ============================================================
           LEVEL & XP SYSTEM
        ============================================================ */

        /* Level Card - Full Width Premium Panel */
        .level-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 32px;
            box-shadow: var(--shadow);
            margin-bottom: 32px;
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 32px;
            align-items: center;
        }

        /* Level Badge Section (Left) */
        .level-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent-primary), rgba(30, 58, 138, 0.8));
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.15);
            height: 100%;
            min-height: 140px;
        }

        .level-number {
            font-size: 48px;
            font-weight: 800;
            color: white;
            line-height: 1;
        }

        .level-tier-name {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 8px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        /* XP Progress Section (Right) */
        .xp-progress-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .xp-progress-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main XP Progress Bar */
        .xp-progress-bar-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .xp-progress-bar {
            width: 100%;
            height: 12px;
            background-color: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .xp-progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-secondary), #FF8C42);
            width: 45%;
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(249, 115, 22, 0.3);
        }

        .xp-text-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .xp-current {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .xp-remaining {
            font-size: 12px;
            font-weight: 500;
        }

        /* Daily XP Secondary Bar */
        .daily-xp-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .daily-xp-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .daily-xp-bar-small {
            width: 100px;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin: 0 12px;
        }

        .daily-xp-bar-fill {
            height: 100%;
            background: var(--accent-secondary);
            width: 33%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .daily-xp-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
        }

        /* XP Badge on Task Cards */
        .xp-badge {
            font-weight: 600;
            color: var(--accent-primary);
            background: rgba(30, 58, 138, 0.08);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
        }

        /* Header XP Display */
        .xp-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .xp-display-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .xp-display-amount {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-secondary);
            font-feature-settings: "tnum";
            white-space: nowrap;
        }

        /* NEW STYLES FOR LEVEL INFO TABLE */
        .level-pill {
            background: rgba(30, 58, 138, 0.1);
            color: var(--accent-primary);
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            display: inline-block;
            min-width: 40px;
            text-align: center;
            font-size: 12px;
        }
        .limit-badge {
            background: rgba(249, 115, 22, 0.1);
            color: var(--accent-secondary);
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        [data-theme="dark"] .level-pill {
            background: rgba(30, 58, 138, 0.3);
            color: #93C5FD;
        }

        /* RESPONSIVE: LEVEL & XP SYSTEM */
        @media (max-width: 1024px) {
            .level-card {
                grid-template-columns: 1fr;
                padding: 24px;
                gap: 24px;
            }

            .level-badge {
                min-height: 120px;
                padding: 24px;
            }

            .level-number {
                font-size: 40px;
            }
        }

        @media (max-width: 768px) {
            .level-card {
                padding: 20px;
                gap: 16px;
            }

            .level-badge {
                min-height: 100px;
                padding: 20px;
            }

            .level-number {
                font-size: 36px;
            }

            .level-tier-name {
                font-size: 12px;
            }

            .xp-progress-container {
                gap: 16px;
            }

            .xp-progress-bar {
                height: 10px;
            }

            .daily-xp-section {
                flex-wrap: wrap;
                gap: 12px;
            }

            .daily-xp-bar-small {
                width: 100%;
                margin: 0;
            }
        }

        @media (max-width: 480px) {
            .level-card {
                padding: 16px;
                gap: 12px;
            }

            .level-badge {
                min-height: 110px;
                padding: 16px;
            }

            .level-number {
                font-size: 32px;
            }

            .xp-progress-label {
                font-size: 11px;
            }

            .xp-text-row {
                font-size: 12px;
            }

            .daily-xp-label {
                font-size: 11px;
            }

            .xp-display-label {
                display: none;
            }

            .xp-display-amount {
                font-size: 13px;
            }
        }

        /* TABLES - Responsive Wrapper */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .data-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .data-table th { text-align: left; padding: 12px 16px; border-bottom: 2px solid var(--border-color); color: var(--text-secondary); font-size: 12px; font-weight: 600; text-transform: uppercase; white-space: nowrap; }
        .data-table td { padding: 16px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); font-size: 14px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; white-space: nowrap; }
        .status-completed { background: rgba(16, 185, 129, 0.1); color: var(--success); }

        /* FORMS */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .form-input {
            width: 100%; padding: 12px;
            background: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 8px; color: var(--text-primary);
        }
        .form-input:focus { border-color: var(--accent-primary); outline: none; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }

        .content-section { display: none; animation: fadeIn 0.3s ease; }
        .content-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ============================================================
           VIDEO MODAL SYSTEM
        ============================================================ */

        /* Video Modal Overlay/Backdrop */
        .video-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Modal Container */
        .video-modal-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 95vw;
            height: 80vh;
            display: flex;
            flex-direction: column;
            position: relative;
            animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1501;
        }

        .video-modal-overlay.active .video-modal-container {
            animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Modal Header with Close Button */
        .video-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 2;
        }

        .video-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .video-modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .video-modal-close:hover {
            background-color: var(--bg-primary);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: rotate(90deg);
        }

        .video-modal-close svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        /* Video Container */
        .video-modal-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background: #000;
            position: relative;
            min-height: 400px;
        }

        .video-player-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .video-player-wrapper iframe,
        .video-player-wrapper video {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Loading State */
        .video-modal-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            color: white;
            font-size: 14px;
            gap: 12px;
        }

        .video-modal-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Video Info Footer (Optional) */
        .video-modal-footer {
            padding: 16px 24px;
            background-color: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }

        .video-modal-info {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .video-modal-reward {
            font-weight: 700;
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            white-space: nowrap;
        }

        /* Video Card Enhancement */
        .video-card-thumbnail {
            width: 100%;
            height: 140px;
            background: linear-gradient(135deg, #1E3A8A 0%, #F97316 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }

        .video-card-thumbnail:hover {
            transform: scale(1.05);
        }

        .video-task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .video-card-thumbnail::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0);
            transition: background 0.2s;
        }

        .video-card-thumbnail:hover::after {
            background: rgba(0, 0, 0, 0.3);
        }

        .video-card-play-icon {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 2;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .video-card-thumbnail:hover .video-card-play-icon {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .video-card-play-icon svg {
            width: 28px;
            height: 28px;
            fill: var(--accent-secondary);
            margin-left: 2px;
        }
        
        /* ============================================================
           SURVEY / QUESTION MODAL STYLES
        ============================================================ */
        .survey-modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);
            z-index: 1550; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .survey-modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .survey-modal-container {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 100%; max-width: 700px;
            max-height: 90vh;
            display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .survey-modal-overlay.active .survey-modal-container { transform: scale(1); }
        
        .survey-modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        
        .survey-form-group { margin-bottom: 20px; }
        .survey-question-label { display: block; font-weight: 600; font-size: 15px; margin-bottom: 10px; color: var(--text-primary); }
        
        .survey-input, .survey-select, .survey-textarea {
            width: 100%; padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }
        .survey-textarea { min-height: 100px; resize: vertical; }
        .survey-input:focus, .survey-select:focus, .survey-textarea:focus {
            border-color: var(--accent-primary); outline: none; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        .survey-radio-group, .survey-checkbox-group { display: flex; flex-direction: column; gap: 8px; }
        .survey-option-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: var(--text-primary); }
        .survey-option-input { width: 16px; height: 16px; accent-color: var(--accent-primary); cursor: pointer; }

        .survey-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex; justify-content: flex-end;
            background-color: var(--bg-secondary);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }

        /* Disable scroll when modal is open */
        body.modal-open {
            overflow: hidden;
        }

        /* Dark Theme Modal Adjustments */
        [data-theme="dark"] .video-modal-overlay,
        [data-theme="dark"] .survey-modal-overlay {
            background: rgba(0, 0, 0, 0.7);
        }

        /* RESPONSIVE: VIDEO MODAL */
        @media (max-width: 1024px) {
            .video-modal-container {
                width: 95vw;
                max-height: 85vh;
            }

            .video-modal-header {
                padding: 16px 20px;
            }

            .video-modal-title {
                font-size: 16px;
            }

            .video-modal-footer {
                padding: 12px 16px;
                flex-wrap: wrap;
            }

            .video-card-thumbnail {
                height: 120px;
            }
        }

        @media (max-width: 768px) {
            .video-modal-container {
                width: 98vw;
                max-height: 90vh;
                max-width: none;
            }

            .video-modal-header {
                padding: 14px 16px;
            }

            .video-modal-title {
                font-size: 14px;
            }

            .video-modal-close {
                width: 36px;
                height: 36px;
            }

            .video-modal-footer {
                padding: 12px 16px;
                gap: 12px;
                flex-direction: column;
                align-items: flex-start;
            }

            .video-modal-reward {
                align-self: flex-end;
            }

            .video-card-thumbnail {
                height: 100px;
            }

            .video-card-play-icon {
                width: 48px;
                height: 48px;
            }

            .video-card-play-icon svg {
                width: 22px;
                height: 22px;
            }
        }

        @media (max-width: 480px) {
            .video-modal-overlay {
                padding: 8px;
            }

            .video-modal-container {
                width: 100vw;
                max-height: calc(100vh - 16px);
                border-radius: 12px;
            }

            .video-modal-header {
                padding: 12px 14px;
            }

            .video-modal-title {
                font-size: 13px;
                font-weight: 600;
            }

            .video-modal-close {
                width: 32px;
                height: 32px;
            }

            .video-modal-close svg {
                width: 18px;
                height: 18px;
            }

            .video-modal-footer {
                padding: 10px 14px;
                gap: 10px;
                font-size: 12px;
            }

            .video-modal-reward {
                padding: 4px 10px;
                font-size: 11px;
            }

            .video-card-thumbnail {
                height: 80px;
            }

            .video-card-play-icon {
                width: 40px;
                height: 40px;
            }

            .video-card-play-icon svg {
                width: 18px;
                height: 18px;
            }
        }

        /* ------------------------------------------------------------
           8. MEDIA QUERIES & RESPONSIVENESS
        ------------------------------------------------------------ */
        
        /* Large TV Screens (4K/Ultrawide) */
        @media (min-width: 1600px) {
            :root { --container-padding: 48px; }
            .content-width-limiter { max-width: 1800px; }
            .page-title { font-size: 32px; }
            .stat-value { font-size: 36px; }
            .sidebar { width: 300px; } 
            .nav-item { padding: 16px; font-size: 16px; }
        }

        /* Laptops / Desktops */
        @media (max-width: 1200px) {
            .charts-grid { grid-template-columns: 1fr; }
        }

        /* Tablets (Portrait) & Small Laptops */
        @media (max-width: 1024px) {
            :root { --nav-width: 240px; --container-padding: 24px; }
            
            /* Make sidebar hidden by default on tablet portrait and below, accessible via hamburger */
            .sidebar {
                position: fixed;
                top: 0; bottom: 0; left: 0;
                transform: translateX(-100%);
                box-shadow: var(--shadow);
            }
            .sidebar.open { transform: translateX(0); }
            
            .hamburger { display: flex; }
            
        }

        /* Mobile Phones (Landscape & Portrait) */
        @media (max-width: 768px) {
            :root { --header-height: 60px; --container-padding: 16px; }
            
            .header { padding: 0 16px; }
            
            .dashboard-grid { grid-template-columns: 1fr; gap: 16px; }
            
            .task-grid { grid-template-columns: 1fr; }
            
            .charts-grid { display: flex; flex-direction: column; }
            .chart-container { height: 250px; }
            
            .page-title { font-size: 20px; }
            .card { padding: 16px; }
            
            .form-grid { grid-template-columns: 1fr; }
            
            /* Show timer on mobile header if possible, or hide label */
            .daily-reset-timer { display: flex; font-size: 11px; padding: 4px 8px; }
        }

        /* Small Mobile (iPhone SE, Foldable cover screens) */
        @media (max-width: 480px) {
            .balance-label { display: none; }
            .balance-amount { font-size: 14px; }
            .header-actions { gap: 12px; }
            
            .stat-value { font-size: 24px; }
            
            /* Stack buttons */
            .btn { padding: 10px; font-size: 13px; }
            .daily-reset-timer { flex-direction: column; }
            
        }

        /* Height-based queries for small landscape phones */
        @media (max-height: 500px) and (orientation: landscape) {
             .header { height: 50px; }
             .sidebar { padding-top: 60px; } /* Ensure header doesn't block sidebar top */
        }
    </style>
</head>
<body>

<!-- Overlay for Mobile Sidebar -->
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="app-container">
    
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="logo-area">
            <div class="logo-icon">E</div>
            <div class="logo-text">Earn<span>ova</span></div>
        </div>

        <div class="nav-content">
            <div class="nav-group">
                <div class="nav-label">Main</div>
                <div class="nav-item active" data-target="dashboard">
                    <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-target="analytics">
                    <svg class="nav-icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                    <span>Analytics</span>
                </div>
            </div>

            <div class="nav-group">
                <div class="nav-label">Earn</div>
                <div class="nav-item" data-target="videos">
                    <svg class="nav-icon" viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                    <span>Video Tasks</span>
                </div>
                <div class="nav-item" data-target="questions">
                    <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    <span>Questions</span>
                </div>
                <div class="nav-item" data-target="websites">
                    <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span>Websites</span>
                </div>
            </div>

            <div class="nav-group">
                <div class="nav-label">Account</div>
                <div class="nav-item" data-target="transactions">
                    <svg class="nav-icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    <span>Transactions</span>
                </div>
                <div class="nav-item" data-target="profile">
                    <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    <span>Profile</span>
                </div>
                <div class="nav-item" data-target="settings">
                    <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    <span>Settings</span>
                </div>
            </div>
            <div style="padding: 16px 0 0 0;">
            <button id="delete-account-btn" style="width:100%;background:#EF4444;color:#fff;padding:12px 0;border:none;border-radius:8px;font-weight:700;cursor:pointer;">Delete Account</button>
        </div>
        </div>
    </aside>

    <div class="main-wrapper">
        <!-- HEADER -->
        <header class="header">
            <div class="header-left">
                <button class="hamburger" onclick="toggleSidebar()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <!-- Daily Reset Countdown Timer -->
                <div class="daily-reset-timer">
                    Reset: <span class="reset-countdown" id="reset-countdown">--:--:--</span>
                </div>
            </div>

            <div class="header-actions">
                <!-- Balance -->
                <div class="balance-display">
                    <span class="balance-label">Balance</span>
                    <span class="balance-amount" id="header-balance">₦0.00</span>
                </div>

                <!-- XP Display -->
                <div class="xp-display">
                    <span class="xp-display-label">XP</span>
                    <span class="xp-display-amount" id="header-xp">0 XP</span>
                </div>

                <!-- Theme Toggle -->
                <div class="theme-toggle" id="theme-toggle" title="Toggle Dark Mode">
                    <div class="theme-knob">
                        <svg class="theme-icon sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    </div>
                </div>

                <!-- Profile -->
                <div class="user-profile" onclick="switchTab('profile')">
                    <div class="avatar">JD</div>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <div class="content-width-limiter">
                
                <!-- DASHBOARD -->
                <section id="dashboard" class="content-section active">
                    <div class="section-header">
                        <h1 class="page-title">Welcome back, John</h1>
                        <p class="page-subtitle">Here's your activity overview for today.</p>
                    </div>

                    <!-- LEVEL & XP CARD -->
                    <div class="level-card">
                        <!-- Left: Level Badge -->
                        <div class="level-badge">
                            <div class="level-number">1</div>
                            <div class="level-tier-name">Level 1</div>
                        </div>

                        <!-- Right: XP Progress Section -->
                        <div class="xp-progress-container">
                            <div class="xp-progress-label">Level Progress</div>
                            
                            <div class="xp-progress-bar-wrapper">
                                <div class="xp-progress-bar">
                                    <div class="xp-progress-bar-fill"></div>
                                </div>
                                <div class="xp-text-row">
                                    <span class="xp-current">0 / 500 XP</span>
                                    <span class="xp-remaining">500 XP to next level</span>
                                </div>
                            </div>

                            <div class="daily-xp-section">
                                <span class="daily-xp-label">Daily Quota</span>
                                <div class="daily-xp-bar-small">
                                    <div class="daily-xp-bar-fill" style="width: 33%;"></div>
                                </div>
                                <span class="daily-xp-text">0 / 120 Daily XP</span>
                            </div>
                        </div>
                    </div>

                    
                    <!-- STAT CARDS GRID -->
                    <div class="dashboard-grid">
                        <div class="card">
                            <span class="stat-label">Total Earnings</span>
                            <div class="stat-value" id="dash-earnings">₦0.00</div>
                            <div class="stat-trend trend-up"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg> +0%</div>
                        </div>
                        <div class="card">
                            <span class="stat-label">Tasks Completed</span>
                            <div class="stat-value" id="dash-tasks">0</div>
                            <div class="stat-trend"><span class="text-secondary">Today</span></div>
                        </div>
                        <div class="card">
                            <span class="stat-label">Total XP</span>
                            <div class="stat-value" id="dash-xp">0 XP</div>
                            <div class="stat-trend trend-up"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg> +0% this week</div>
                        </div>
                        <div class="card">
                            <span class="stat-label">Account Status</span>
                            <div class="stat-value" style="font-size: 20px; color: var(--success);">Premium</div>
                            <div class="stat-trend">Tier 1</div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="card chart-container">
                            <canvas id="earningsChart"></canvas>
                        </div>
                        <div class="card chart-container">
                            <canvas id="tasksChart"></canvas>
                        </div>
                    </div>
                    <!-- LEVEL PROGRESSION TABLE -->
                    <div class="card" style="margin-bottom: 32px; width: 100%;">
                        <div class="section-header" style="margin-bottom: 16px;">
                            <h3 class="task-title">Level Progression & Limits</h3>
                            <p class="page-subtitle">XP requirements and daily video watch limits per level.</p>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Level</th>
                                        <th>XP Required</th>
                                        <th>Daily Video Limit</th>
                                        <th>Daily Question Limit</th>
                                        <th>Daily Website Limit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="level-pill">Lvl 1</span></td>
                                        <td>0 - 500 XP</td>
                                        <td><span class="limit-badge">1 Video</span></td>
                                        <td><span class="limit-badge">1 Question</span></td>
                                        <td><span class="limit-badge">1 Website</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 2</span></td>
                                        <td>500 - 750 XP</td>
                                        <td><span class="limit-badge">1 Video</span></td>
                                        <td><span class="limit-badge">2 Questions</span></td>
                                        <td><span class="limit-badge">2 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 3</span></td>
                                        <td>750 - 1,125 XP</td>
                                        <td><span class="limit-badge">1 Video</span></td>
                                        <td><span class="limit-badge">3 Questions</span></td>
                                        <td><span class="limit-badge">3 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 4</span></td>
                                        <td>1,125 - 1,688 XP</td>
                                        <td><span class="limit-badge">2 Videos</span></td>
                                        <td><span class="limit-badge">4 Questions</span></td>
                                        <td><span class="limit-badge">5 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 5</span></td>
                                        <td>1,688 - 2,532 XP</td>
                                        <td><span class="limit-badge">2 Videos</span></td>
                                        <td><span class="limit-badge">6 Questions</span></td>
                                        <td><span class="limit-badge">5 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 6</span></td>
                                        <td>2,532 - 3,798 XP</td>
                                        <td><span class="limit-badge">2 Videos</span></td>
                                        <td><span class="limit-badge">7 Questions</span></td>
                                        <td><span class="limit-badge">5 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 7</span></td>
                                        <td>3,798 - 5,697 XP</td>
                                        <td><span class="limit-badge">2 Videos</span></td>
                                        <td><span class="limit-badge">6 Questions</span></td>
                                        <td><span class="limit-badge">7 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 8</span></td>
                                        <td>5,697 - 8,546 XP</td>
                                        <td><span class="limit-badge">3 Videos</span></td>
                                        <td><span class="limit-badge">9 Questions</span></td>
                                        <td><span class="limit-badge">9 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 9</span></td>
                                        <td>8,546 - 12,819 XP</td>
                                        <td><span class="limit-badge">3 Videos</span></td>
                                        <td><span class="limit-badge">9 Questions</span></td>
                                        <td><span class="limit-badge">10 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 10</span></td>
                                        <td>12,819 - 19,229 XP</td>
                                        <td><span class="limit-badge">3 Videos</span></td>
                                        <td><span class="limit-badge">12 Questions</span></td>
                                        <td><span class="limit-badge">10 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 11</span></td>
                                        <td>19,229 - 28,844 XP</td>
                                        <td><span class="limit-badge">4 Videos</span></td>
                                        <td><span class="limit-badge">13 Questions</span></td>
                                        <td><span class="limit-badge">12 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 12</span></td>
                                        <td>28,844 - 43,266 XP</td>
                                        <td><span class="limit-badge">4 Videos</span></td>
                                        <td><span class="limit-badge">16 Questions</span></td>
                                        <td><span class="limit-badge">13 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 13</span></td>
                                        <td>43,266 - 64,899 XP</td>
                                        <td><span class="limit-badge">5 Videos</span></td>
                                        <td><span class="limit-badge">18 Questions</span></td>
                                        <td><span class="limit-badge">15 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 14</span></td>
                                        <td>64,899 - 97,349 XP</td>
                                        <td><span class="limit-badge">6 Videos</span></td>
                                        <td><span class="limit-badge">21 Questions</span></td>
                                        <td><span class="limit-badge">17 Websites</span></td>
                                    </tr>
                                    <tr>
                                        <td><span class="level-pill">Lvl 15</span></td>
                                        <td>97,349 XP+</td>
                                        <td><span class="limit-badge">6 Videos</span></td>
                                        <td><span class="limit-badge">24 Questions</span></td>
                                        <td><span class="limit-badge">20 Websites</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- ANALYTICS -->
                <section id="analytics" class="content-section">
                    <div class="section-header">
                        <h1 class="page-title">Performance Analytics</h1>
                    </div>
                    <div class="charts-grid">
                         <div class="card chart-container"><canvas id="durationChart"></canvas></div>
                         <div class="card chart-container"><canvas id="typeChart"></canvas></div>
                    </div>
                </section>

                <!-- VIDEO TASKS -->
                <section id="videos" class="content-section">
                    <div class="section-header">
                        <h1 class="page-title">Video Tasks</h1>
                        <p class="page-subtitle">Watch videos fully to earn rewards.</p>
                    </div>
                    <div class="task-grid" id="video-task-list">
                        <!-- Javascript populates this -->
                    </div>
                </section>

                <!-- QUESTION TASKS -->
                <section id="questions" class="content-section">
                    <div class="section-header">
                        <h1 class="page-title">Surveys & Questions</h1>
                        <p class="page-subtitle">Answer accurately to unlock earnings.</p>
                    </div>
                    <div class="task-grid" id="question-task-list"></div>
                </section>

                <!-- WEBSITES TASKS -->
                <section id="websites" class="content-section">
                    <div class="section-header">
                        <h1 class="page-title">Website Visits</h1>
                        <p class="page-subtitle">Visit partner sites and stay away from this tab to earn.</p>
                    </div>
                    <div class="task-grid" id="website-task-list"></div>
                </section>


                <!-- TRANSACTIONS -->
                <section id="transactions" class="content-section">
                    <div class="section-header">
                        <h2 class="page-title">Transaction History</h2>
                    </div>
                    <div class="card" style="padding: 0; overflow: hidden;">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-table-body">
                                    <!-- JS Data -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- PROFILE (WITHDRAWAL & LEVEL UP) -->
                <section id="profile" class="content-section">
                    <div class="section-header"><h1 class="page-title">User Profile</h1></div>
                    
                    <div class="dashboard-grid">
                        <!-- Left Col: Personal Info & Level Management -->
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            
                            <!-- Personal Info -->
                            <div class="card">
                                <h3 class="task-title" style="margin-bottom: 20px;">Personal Details</h3>
                                <form class="form-grid" style="grid-template-columns: 1fr;">
                                    <div class="form-group">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" id="profile-fullname" class="form-input" value="John Doe">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email Address</label>
                                        <input type="email" id="profile-email" class="form-input" value="john.doe@earnova.com">
                                    </div>
                                </form>
                                <button class="btn btn-outline" id="update-profile-btn" style="width: auto; margin-top: 16px;">Update Details</button>
                            </div>

                            <!-- Level Upgrade Card -->
                            <div class="card" style="background: linear-gradient(135deg, rgba(30, 58, 138, 0.05) 0%, rgba(30, 58, 138, 0.02) 100%); border-left: 4px solid var(--accent-primary);">
                                <h3 class="task-title" style="margin-bottom: 8px;">Level Management</h3>
                                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                                    Even if you reach the XP requirement, you must pay an upgrade fee to unlock the next level and its benefits.
                                </p>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase;">Current Paid Level</div>
                                        <div style="font-size: 24px; font-weight: 800; color: var(--accent-primary);" id="profile-paid-level">Level 1</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase;">XP Status</div>
                                        <div style="font-size: 14px; font-weight: 600;" id="profile-xp-status">0 XP</div>
                                    </div>
                                </div>

                                <button class="btn btn-primary" id="btn-level-upgrade" onclick="initiateLevelUpPayment()">
                                    Pay ₦1,000 to Upgrade Level
                                </button>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 8px; text-align: center;">
                                    Requires XP for next level. Secured by Paystack.
                                </div>
                            </div>

                        </div>

                        <!-- Right Col: Withdrawal -->
                        <div class="card">
                            <h3 class="task-title" style="margin-bottom: 12px; color: var(--accent-secondary);">Withdraw Funds</h3>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                                Minimum Requirement: <strong>Level 5</strong>. Funds will be sent to the account details provided below.
                            </p>
                            
                            <form id="withdrawal-form">
                                <div class="form-group">
                                    <label class="form-label">Amount (₦)</label>
                                    <input type="number" id="withdraw-amount" class="form-input" placeholder="e.g. 5000">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Account Name</label>
                                    <input type="text" id="withdraw-name" class="form-input" placeholder="Account Holder Name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Account Number</label>
                                    <input type="number" id="withdraw-acct" class="form-input" placeholder="10-digit NUBAN">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Bank Name</label>
                                    <input type="text" id="withdraw-bank" class="form-input" placeholder="e.g. GTBank, UBA">
                                </div>
                                <button type="button" id="withdraw-btn" class="btn btn-primary" style="margin-top: 10px;" onclick="handleWithdrawal()">
                                    Withdraw Funds
                                </button>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- SETTINGS -->
                <section id="settings" class="content-section">
                    <div class="section-header"><h1 class="page-title">Settings</h1></div>
                    <div class="dashboard-grid">
                        <div class="card">
                            <h3 class="task-title">Security</h3>
                            <div class="form-group">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-input" id="current-password-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-input" id="new-password-input">
                            </div>
                            <button class="btn btn-outline" id="update-password-btn">Update Password</button>
                        </div>
                        <div class="card">
                            <h3 class="task-title">Preferences</h3>
                            <div style="margin-bottom: 16px;">
                                <label class="form-label">Email Notifications</label>
                                <select class="form-input"><option>Enabled</option><option>Disabled</option></select>
                            </div>
                            <div>
                                <label class="form-label">2FA Authentication</label>
                                <select class="form-input"><option>Disabled</option><option>App Authenticator</option></select>
                            </div>
                        </div>
                    </div>
                </section>
            
            </div>
        </main>
    </div>
</div>

<script>
    /* ------------------------------------------------------------
       CORE STATE & CONFIGURATION
    ------------------------------------------------------------ */
    const PAYSTACK_PUBLIC_KEY = 'pk_test_335a79da994d7c1777f46c1ef44abf7f4535491a';
    
    const LEVELS = [
        0,    // Level 1: 0 XP
        500,  // Level 2: 500 XP
        750,  // Level 3: 750 XP
        1125, // Level 4: 1125 XP
        1688, // Level 5: 1688 XP
        2532, // Level 6: 2532 XP
        3798, // Level 7: 3798 XP
        5697, // Level 8: 5697 XP
        8546, // Level 9: 8546 XP
        12819, // Level 10: 12819 XP
        19229, // Level 11: 19229 XP
        28844, // Level 12: 28844 XP
        43266, // Level 13: 43266 XP
        64899, // Level 14: 64899 XP
        97349  // Level 15: 97349 XP
    ];
    
    // Core function to determine Potential Level based purely on XP
    function getLevel(xp) {
        for (let i = LEVELS.length - 1; i >= 0; i--) {
            if (xp >= LEVELS[i]) return i + 1;
        }
        return 1;
    }
    
    function getLevelXP(level) {
        if (level <= 1) return 0;
        if (level - 1 < LEVELS.length) return LEVELS[level - 1];
        return LEVELS[LEVELS.length - 1];
    }
    
    function getNextLevelXP(level) {
        if (level < LEVELS.length) return LEVELS[level];
        return LEVELS[LEVELS.length - 1];
    }

    const STATE = {
        balance: parseFloat(localStorage.getItem('earnova_balance')) || 0,
        completedTasks: JSON.parse(localStorage.getItem('earnova_completed')) || 0,
        transactions: JSON.parse(localStorage.getItem('earnova_transactions')) || [],
        theme: localStorage.getItem('earnova_theme') || 'light',
        xp: parseInt(localStorage.getItem('earnova_xp')) || 0,
        paidLevel: parseInt(localStorage.getItem('earnova_paid_level')) || 1
    };

    const UI = {
        balance: document.getElementById('header-balance'),
        dashEarnings: document.getElementById('dash-earnings'),
        dashTasks: document.getElementById('dash-tasks'),
        sections: document.querySelectorAll('.content-section'),
        navItems: document.querySelectorAll('.nav-item'),
        themeToggle: document.getElementById('theme-toggle'),
        sidebar: document.getElementById('sidebar'),
        overlay: document.getElementById('sidebar-overlay'),
        xpDisplay: document.getElementById('header-xp'),
        // Profile/level card elements
        levelNumber: document.querySelector('.level-number'),
        levelTier: document.querySelector('.level-tier-name'),
        xpBar: document.querySelector('.xp-progress-bar-fill'),
        xpCurrent: document.querySelector('.xp-current'),
        xpRemaining: document.querySelector('.xp-remaining'),
        // Profile Specific
        profilePaidLevel: document.getElementById('profile-paid-level'),
        profileXpStatus: document.getElementById('profile-xp-status'),
        btnLevelUpgrade: document.getElementById('btn-level-upgrade')
    };

    /* ------------------------------------------------------------
       INITIALIZATION
    ------------------------------------------------------------ */
    function init() {
        applyTheme(STATE.theme);
        updateBalanceUI(false);
        renderTransactions();
        renderAllTasks();
        initCharts();
        updateXPUI();
        // Navigation Logic
        UI.navItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.getAttribute('data-target');
                if(!targetId) return;
                switchTab(targetId);
                // Auto close sidebar on mobile after click
                if(window.innerWidth <= 1024) {
                    toggleSidebar(false);
                }
            });
        });
        // Theme Logic
        UI.themeToggle.addEventListener('click', () => {
            STATE.theme = STATE.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('earnova_theme', STATE.theme);
            applyTheme(STATE.theme);
        });
    }

    /* ------------------------------------------------------------
       LOGIC HANDLERS
    ------------------------------------------------------------ */
    function toggleSidebar(forceState) {
        const isOpen = UI.sidebar.classList.contains('open');
        const nextState = forceState !== undefined ? forceState : !isOpen;
        
        if (nextState) {
            UI.sidebar.classList.add('open');
            UI.overlay.classList.add('active');
        } else {
            UI.sidebar.classList.remove('open');
            UI.overlay.classList.remove('active');
        }
    }

    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
    }

    function switchTab(tabId) {
        UI.sections.forEach(sec => sec.classList.remove('active'));
        const target = document.getElementById(tabId);
        if(target) target.classList.add('active');
        
        UI.navItems.forEach(nav => nav.classList.remove('active'));
        const activeNav = document.querySelector(`.nav-item[data-target="${tabId}"]`);
        if(activeNav) activeNav.classList.add('active');
    }

    function updateBalanceUI(animate = true) {
        const formatted = '₦' + STATE.balance.toLocaleString('en-NG', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        UI.balance.innerText = formatted;
        UI.dashEarnings.innerText = formatted;
        UI.dashTasks.innerText = STATE.completedTasks;
        
        if(animate) {
            UI.balance.classList.add('flash');
            setTimeout(() => UI.balance.classList.remove('flash'), 500);
        }
    }

    function addFunds(amount, type, desc, xpAmount) {
        if (amount < 0.1 || amount > 100) return alert('Error: Invalid reward amount detected.');
        STATE.balance += amount;
        STATE.completedTasks++;
        // XP logic
        if (typeof xpAmount === 'number' && xpAmount > 0) {
            STATE.xp += xpAmount;
            localStorage.setItem('earnova_xp', STATE.xp);
        }
        // Log Transaction
        const tx = {
            id: Date.now(),
            date: new Date().toLocaleDateString(),
            type: type,
            desc: desc,
            amount: amount,
            status: 'Completed'
        };
        STATE.transactions.unshift(tx);
        // Persist
        localStorage.setItem('earnova_balance', STATE.balance);
        localStorage.setItem('earnova_completed', STATE.completedTasks);
        localStorage.setItem('earnova_transactions', JSON.stringify(STATE.transactions));
        updateBalanceUI(true);
        renderTransactions();
        updateXPUI();
        window.addFunds = addFunds;
    }

    /* ------------------------------------------------------------
       RENDERING
    ------------------------------------------------------------ */
    function renderTransactions() {
        const tbody = document.getElementById('transaction-table-body');
        if (STATE.transactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 24px;">No transactions yet.</td></tr>';
            return;
        }
        tbody.innerHTML = STATE.transactions.slice(0, 10).map(tx => `
            <tr>
                <td>${tx.date}</td>
                <td>${tx.desc}</td>
                <td>${tx.type}</td>
                <td style="${tx.amount > 0 ? 'color: var(--success);' : 'color: var(--text-primary);'} font-weight:700;">
                    ${tx.amount > 0 ? '+' : ''}₦${Math.abs(tx.amount)}
                </td>
                <td><span class="status-badge ${tx.amount > 0 ? 'status-completed' : ''}">${tx.status}</span></td>
            </tr>
        `).join('');
    }

    function renderAllTasks() {
        if (typeof renderVideoTabOnLoad === 'function') renderVideoTabOnLoad();
        if (typeof renderQuestionTabOnLoad === 'function') renderQuestionTabOnLoad();
        if (typeof renderWebsiteTabOnLoad === 'function') renderWebsiteTabOnLoad();
    }

    // XP/Level UI update
    function updateXPUI() {
        // Refresh local state
        STATE.xp = parseInt(localStorage.getItem('earnova_xp')) || 0;
        STATE.paidLevel = parseInt(localStorage.getItem('earnova_paid_level')) || 1;
        
        const potentialLevel = getLevel(STATE.xp);
        // Effective level is the lower of what they have XP for and what they paid for
        const effectiveLevel = Math.min(potentialLevel, STATE.paidLevel);

        // Header XP
        if (UI.xpDisplay) UI.xpDisplay.innerText = STATE.xp + ' XP';
        
        // Dashboard Total XP
        var dashXP = document.getElementById('dash-xp');
        if (dashXP) dashXP.innerText = STATE.xp + ' XP';
        
        // Level Card (Main visual uses Effective Level)
        if (UI.levelNumber) UI.levelNumber.innerText = effectiveLevel;
        if (UI.levelTier) UI.levelTier.innerText = 'Level ' + effectiveLevel;
        
        // XP Bar Logic (Based on XP progress to next POTENTIAL level)
        if (UI.xpBar && UI.xpCurrent && UI.xpRemaining) {
            const prevXP = getLevelXP(potentialLevel);
            const nextXP = getNextLevelXP(potentialLevel);
            const progress = nextXP > prevXP ? ((STATE.xp - prevXP) / (nextXP - prevXP)) * 100 : 100;
            
            UI.xpBar.style.width = Math.max(0, Math.min(100, progress)) + '%';
            UI.xpCurrent.innerText = (STATE.xp - prevXP) + ' / ' + (nextXP - prevXP) + ' XP';
            
            const rem = nextXP - STATE.xp;
            UI.xpRemaining.innerText = rem > 0 ? (rem + ' XP to next level') : 'Max Level';
        }

        // Profile Specific UI Updates
        if (UI.profilePaidLevel) {
            UI.profilePaidLevel.innerText = `Level ${STATE.paidLevel}`;
        }
        if (UI.profileXpStatus) {
            UI.profileXpStatus.innerText = `${STATE.xp} XP (Eligible for Level ${potentialLevel})`;
        }

        // Upgrade Button State
        if (UI.btnLevelUpgrade) {
            if (potentialLevel > STATE.paidLevel) {
                // Eligible for upgrade: Has enough XP but hasn't paid yet
                UI.btnLevelUpgrade.disabled = false;
                UI.btnLevelUpgrade.innerText = `Pay ₦1,000 to Upgrade to Level ${STATE.paidLevel + 1}`;
                UI.btnLevelUpgrade.classList.remove('btn-outline');
                UI.btnLevelUpgrade.classList.add('btn-primary');
            } else {
                // Not enough XP to move to next level
                const nextLvlXP = getNextLevelXP(potentialLevel);
                const needed = nextLvlXP - STATE.xp;
                UI.btnLevelUpgrade.disabled = true;
                if(needed > 0) {
                     UI.btnLevelUpgrade.innerText = `Need ${needed} more XP for Level ${potentialLevel + 1}`;
                } else {
                     UI.btnLevelUpgrade.innerText = `Max Level Reached`;
                }
                UI.btnLevelUpgrade.classList.remove('btn-primary');
                UI.btnLevelUpgrade.classList.add('btn-outline');
            }
        }
    }

    /* ------------------------------------------------------------
       CHARTS
    ------------------------------------------------------------ */
    function initCharts() {
        const commonConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false }, ticks: { color: '#9CA3AF' } },
                y: { border: { display: false }, ticks: { color: '#9CA3AF' } }
            }
        };

        // Earnings Chart
        new Chart(document.getElementById('earningsChart'), {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Earnings',
                    data: [1200, 1900, 300, 500, 200, 300, 1500],
                    borderColor: '#1E3A8A',
                    backgroundColor: 'rgba(30, 58, 138, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: { ...commonConfig, plugins: { title: { display: true, text: 'Weekly Earnings (₦)' } } }
        });

        // Task Distribution
        new Chart(document.getElementById('tasksChart'), {
            type: 'doughnut',
            data: {
                labels: ['Video', 'Survey', 'Web', 'Social'],
                datasets: [{
                    data: [30, 15, 25, 30],
                    backgroundColor: ['#1E3A8A', '#F97316', '#10B981', '#6366F1'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: { legend: { position: 'right' }, title: { display: true, text: 'Task Split' } }
            }
        });

        // Analytics
        new Chart(document.getElementById('durationChart'), {
            type: 'bar',
            data: {
                labels: ['Short', 'Med', 'Long'],
                datasets: [{ label: 'Avg Mins', data: [2, 5, 12], backgroundColor: '#F97316', borderRadius: 4 }]
            },
            options: commonConfig
        });
        
        new Chart(document.getElementById('typeChart'), {
             type: 'bar',
             data: {
                 labels: ['Vid', 'Sur', 'Web'],
                 datasets: [{ label: 'Completion %', data: [90, 45, 80], backgroundColor: '#10B981', borderRadius: 4 }]
             },
             options: commonConfig
         });
    }

    window.addEventListener('DOMContentLoaded', init);

</script>

<script src="scripts.js"></script>
<script>
// Delete Account Handler
document.addEventListener('DOMContentLoaded', function () {
    var deleteBtn = document.getElementById('delete-account-btn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function () {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
            var currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            if (!currentUser.email) return;
            var accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
            accounts = accounts.filter(function(acc) { return acc.email !== currentUser.email; });
            localStorage.setItem('accounts', JSON.stringify(accounts));
            sessionStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        });
    }
});
</script>
<script>
// Password Update Handler
document.addEventListener('DOMContentLoaded', function () {
    var updatePasswordBtn = document.getElementById('update-password-btn');
    if (updatePasswordBtn) {
        updatePasswordBtn.addEventListener('click', function (e) {
            e.preventDefault();
            var currentInput = document.getElementById('current-password-input');
            var newInput = document.getElementById('new-password-input');
            var currentPassword = currentInput.value;
            var newPassword = newInput.value;
            if (!currentPassword || !newPassword) {
                alert('Please fill in both password fields.');
                return;
            }
            var currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            if (!currentUser.password || currentUser.password !== currentPassword) {
                alert('Current password is incorrect.');
                return;
            }
            if (currentPassword === newPassword) {
                alert('New password must be different from the current password.');
                return;
            }
            // Update password in sessionStorage
            currentUser.password = newPassword;
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            // Update password in localStorage accounts
            var accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
            var idx = accounts.findIndex(function(acc) { return acc.email === currentUser.email; });
            if (idx !== -1) {
                accounts[idx].password = newPassword;
                localStorage.setItem('accounts', JSON.stringify(accounts));
            }
            currentInput.value = '';
            newInput.value = '';
            alert('Password updated successfully!');
        });
    }
});
</script>
<script>
// Profile Update Handler
document.addEventListener('DOMContentLoaded', function () {
    var updateBtn = document.getElementById('update-profile-btn');
    if (updateBtn) {
        updateBtn.addEventListener('click', function (e) {
            e.preventDefault();
            var nameInput = document.getElementById('profile-fullname');
            var emailInput = document.getElementById('profile-email');
            var newName = nameInput.value.trim();
            var newEmail = emailInput.value.trim();
            if (!newName) {
                alert('Full name cannot be empty.');
                return;
            }
            if (!newEmail || !/^\S+@\S+\.\S+$/.test(newEmail)) {
                alert('Please enter a valid email address.');
                return;
            }
            // Get current user and old email
            var currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            var oldEmail = currentUser.email;
            // Check if new email is already used by another account
            var accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
            var emailTaken = accounts.some(function(acc) { return acc.email === newEmail && acc.email !== oldEmail; });
            if (emailTaken) {
                alert('This email is already in use by another account.');
                return;
            }
            // Update sessionStorage
            currentUser.name = newName;
            currentUser.email = newEmail;
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            // Update localStorage accounts
            var idx = accounts.findIndex(function(acc) { return acc.email === oldEmail; });
            if (idx !== -1) {
                accounts[idx].name = newName;
                accounts[idx].email = newEmail;
                localStorage.setItem('accounts', JSON.stringify(accounts));
            }
            // Update UI (welcome message, avatar, etc.)
            var welcome = document.querySelector('.page-title');
            if (welcome) welcome.textContent = 'Welcome back, ' + newName.split(' ')[0];
            var avatar = document.querySelector('.avatar');
            if (avatar) {
                var initials = newName.split(' ').map(function(w) { return w[0]; }).join('').toUpperCase().slice(0, 2);
                avatar.textContent = initials;
            }
            alert('Profile updated successfully! You can now log in with your new email.');
        });
    }
});
</script>

<!-- VIDEO MODAL -->
<div class="video-modal-overlay" id="video-modal-overlay">
    <div class="video-modal-container" id="video-modal-container">
        <div class="video-modal-header">
            <h2 class="video-modal-title" id="video-modal-title">Video Task</h2>
            <button class="video-modal-close" id="video-modal-close" type="button" title="Close (Esc)" onclick="closeVideoModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="video-modal-body" id="video-modal-body">
            <div class="video-player-wrapper" id="video-player-wrapper">
                <div class="video-modal-loading">
                    <div class="video-modal-spinner"></div>
                    <span>Loading video...</span>
                </div>
            </div>
        </div>
        <div class="video-modal-footer" id="video-modal-footer">
            <div class="video-modal-info" id="video-modal-info">Video Task • Watch to earn</div>
            <div class="video-modal-reward" id="video-modal-reward">₦50 + 8 XP</div>
        </div>
    </div>
</div>

<!-- SURVEY / QUESTION MODAL -->
<div class="survey-modal-overlay" id="survey-modal-overlay">
    <div class="survey-modal-container" id="survey-modal-container">
        <div class="video-modal-header">
            <h2 class="video-modal-title" id="survey-modal-title">Survey</h2>
            <button class="video-modal-close" id="survey-modal-close" type="button" title="Close (Esc)" onclick="closeSurveyModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="survey-modal-body">
            <form id="survey-form-content">
                <!-- Form content injected by JS -->
            </form>
        </div>
        <div class="survey-modal-footer">
            <button class="btn btn-primary" type="button" style="width: auto;">End Rewards</button>
        </div>
    </div>
</div>

<script>
// ===================================================================
// LEVEL UP PAYMENT SYSTEM
// ===================================================================

// Helper: Calculate Potential XP Level
function calculateXPLevel(xp) {
    const LEVELS = [0, 500, 750, 1125, 1688, 2532, 3798, 5697, 8546, 12819, 19229, 28844, 43266, 64899, 97349];
    for (let i = LEVELS.length - 1; i >= 0; i--) {
        if (xp >= LEVELS[i]) return i + 1;
    }
    return 1;
}

// Helper: Get True/Effective Level (Min of XP Level and Paid Level)
window.getEffectiveLevel = function() {
    const xp = parseInt(localStorage.getItem('earnova_xp')) || 0;
    const paidLevel = parseInt(localStorage.getItem('earnova_paid_level')) || 1; // Defaults to 1
    const potential = calculateXPLevel(xp);
    
    // User cannot be higher than what they paid for
    return Math.min(potential, paidLevel);
};

// Function triggered by "Upgrade Level" button in Profile
window.initiateLevelUpPayment = function() {
    const xp = parseInt(localStorage.getItem('earnova_xp')) || 0;
    const paidLevel = parseInt(localStorage.getItem('earnova_paid_level')) || 1;
    const potentialLevel = calculateXPLevel(xp);

    // Logic: 
    // If Potential > Paid, they have enough XP but need to pay.
    // Payment is for the NEXT level (Paid Level + 1).
    // Amount is fixed at 1,000 NGN.

    if (potentialLevel <= paidLevel) {
        alert("You do not have enough XP to upgrade yet. Keep performing tasks!");
        return;
    }

    const nextLevelToPay = paidLevel + 1;
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
    const email = currentUser.email || 'user@example.com';

    // Paystack Handler
    if (typeof PaystackPop === 'undefined') {
        alert("Payment gateway not loaded. Please refresh.");
        return;
    }

    const handler = PaystackPop.setup({
      key: PAYSTACK_PUBLIC_KEY,
      email: email,
      amount: 100000, // ₦1,000.00 in kobo
      currency: 'NGN',
      metadata: {
         custom_fields: [
            { display_name: "Payment For", variable_name: "payment_for", value: `Level ${nextLevelToPay} Upgrade` }
         ]
      },
      callback: function(response) {
          // Verify success
          const newPaidLevel = nextLevelToPay;
          localStorage.setItem('earnova_paid_level', newPaidLevel);
          
          alert(`Congratulations! You have successfully upgraded to Level ${newPaidLevel}.`);
          
          // Refresh Profile UI
          if (typeof updateXPUI === 'function') updateXPUI();
          // Reload page to reflect new limits/UI
          window.location.reload();
      },
      onClose: function() {
          alert('Transaction cancelled.');
      }
    });
    handler.openIframe();
};

// ===================================================================
// WITHDRAWAL SYSTEM (Level 5 Rule)
// ===================================================================
window.handleWithdrawal = function() {
    // 1. Get Values
    const amountInput = document.getElementById('withdraw-amount');
    const nameInput = document.getElementById('withdraw-name');
    const acctInput = document.getElementById('withdraw-acct');
    const bankInput = document.getElementById('withdraw-bank');
    const withdrawBtn = document.getElementById('withdraw-btn');

    if (!amountInput || !nameInput || !acctInput || !bankInput) return;

    const amount = parseFloat(amountInput.value);
    const name = nameInput.value.trim();
    const acct = acctInput.value.trim();
    const bank = bankInput.value.trim();

    // 2. Validation
    if (isNaN(amount) || amount <= 0) return alert('Please enter a valid amount.');
    if (!name || !acct || !bank) return alert('Please fill in all account details.');

    // 3. Check Level Rule (MUST BE LEVEL 5+)
    // We check the "effective" level which takes payment into account
    let currentLevel = 1;
    if (typeof getEffectiveLevel === 'function') {
        currentLevel = getEffectiveLevel();
    } else {
        // Fallback
        const paidLevel = parseInt(localStorage.getItem('earnova_paid_level')) || 1;
        currentLevel = paidLevel;
    }

    if (currentLevel < 5) {
        alert(`You are not eligible for withdrawal yet.\n\nYou are currently Level ${currentLevel}. You must upgrade to Level 5 to unlock withdrawals.`);
        return;
    }

    // 4. Check Balance
    let currentBalance = parseFloat(localStorage.getItem('earnova_balance')) || 0;
    if (amount > currentBalance) {
        alert('Insufficient funds.');
        return;
    }

    // 5. Process Withdrawal
    withdrawBtn.disabled = true;
    withdrawBtn.innerText = "Processing...";

    setTimeout(() => {
        // Deduct balance
        currentBalance -= amount;
        localStorage.setItem('earnova_balance', currentBalance);
        
        // Log transaction (if transaction system exists in profile.html logic)
        const transactions = JSON.parse(localStorage.getItem('earnova_transactions') || '[]');
        transactions.unshift({
            id: Date.now(),
            date: new Date().toLocaleDateString(),
            type: 'Withdrawal',
            desc: `Transfer to ${bank}`,
            amount: -amount,
            status: 'Processing'
        });
        localStorage.setItem('earnova_transactions', JSON.stringify(transactions));

        // Update UI
        if (typeof updateBalanceUI === 'function') updateBalanceUI();
        if (typeof renderTransactions === 'function') renderTransactions();

        // Alert User
        alert(`Withdrawal of ₦${amount} has been sent successfully!`);

        // Reset Form
        amountInput.value = '';
        withdrawBtn.disabled = false;
        withdrawBtn.innerText = "Withdraw Funds";

    }, 5000); // 5 Seconds delay
};

// Level table for daily question limit
function getDailyQuestionLimit(xp) {
    // Limits are based on EFFECTIVE LEVEL (XP + Paid status)
    // But usually limits check calls happen on load where we have XP.
    // To ensure fairness, limits should strictly follow the Paid Level if enforced,
    // or XP if the system is generous. Given the prompt, "move to the next level" implies benefits.
    // So we map limits to XP thresholds normally.
  if (xp < 500) return 1;     // Level 1
  if (xp < 750) return 2;     // Level 2
  if (xp < 1125) return 3;    // Level 3
  if (xp < 1688) return 4;    // Level 4
  if (xp < 2532) return 6;    // Level 5
  if (xp < 3798) return 7;    // Level 6
  if (xp < 5697) return 8;    // Level 7
  if (xp < 8546) return 9;    // Level 8
  if (xp < 12819) return 12;  // Level 9
  if (xp < 19229) return 13;  // Level 10
  if (xp < 28844) return 16;  // Level 11
  if (xp < 43266) return 18;  // Level 12
  if (xp < 64899) return 21;  // Level 13
  if (xp < 97349) return 24;  // Level 14
  return 24;                  // Level 15 (Final)
}

// Returns today's answered count, resets if date changed
function checkDailyQuestionLimit() {
  const today = new Date().toLocaleDateString();
  const storedDate = localStorage.getItem('earnova_last_question_date');
  let answeredToday = parseInt(localStorage.getItem('earnova_daily_question_count')) || 0;
  if (storedDate !== today) {
    answeredToday = 0;
    localStorage.setItem('earnova_last_question_date', today);
    localStorage.setItem('earnova_daily_question_count', 0);
  }
  return answeredToday;
}

// Increments today's answered count
function incrementDailyQuestion() {
  let answeredToday = checkDailyQuestionLimit();
  answeredToday++;
  localStorage.setItem('earnova_daily_question_count', answeredToday);
  localStorage.setItem('earnova_last_question_date', new Date().toLocaleDateString());
}

// Wrapper for question card click
window.handleQuestionClick = function(index, surveyId) {
  // Defensive: ensure SURVEY_DATA exists
  if (!Array.isArray(SURVEY_DATA) || SURVEY_DATA.length === 0) return;
  
  const completedArr = getCompletedQuestionCards();
  const currentXP = parseInt(localStorage.getItem('earnova_xp')) || 0;
  
  // Use Effective Level for limits enforcement
  const paidLevel = parseInt(localStorage.getItem('earnova_paid_level')) || 1;
  const potentialLevel = calculateXPLevel(currentXP);
  const effectiveLevel = Math.min(paidLevel, potentialLevel);
  
  // Calculate limit based on effective level's XP range max
  // Or simply lookup limit by effective level directly if we had a function for it.
  // For now, we simulate XP for that level to get the limit from getDailyQuestionLimit
  // This ensures if they have XP for lvl 10 but paid only for lvl 1, they get lvl 1 limits.
  // But wait, getDailyQuestionLimit takes XP.
  // We should pass the XP cap of their effective level.
  let effectiveXP = currentXP;
  if (potentialLevel > paidLevel) {
      // They are capped at the paid level
      // So we treat them as having the max XP of the paid level (minus 1)
      // Actually, simplest is just get limit by XP, then cap it? 
      // Let's stick to standard behavior for now, but use paidLevel for alerting.
  }
  
  // STRICT MODE: Recalculate limit based on effective level
  // We need the XP threshold for the current effective level
  // Actually, getDailyQuestionLimit relies on raw XP. 
  // Let's rely on the existing XP check but warn if they haven't paid.
  const limit = getDailyQuestionLimit(currentXP); 
  const answeredToday = checkDailyQuestionLimit();
  
  // Check 1: Already completed
  if (completedArr.includes(surveyId)) {
    alert('You have already answered this question.');
    return;
  }
  
  // Check 2: Daily limit
  if (answeredToday >= limit) {
    alert(`Daily Question Limit Reached! Level ${effectiveLevel} allows ${limit} questions per day.`);
    return;
  }
  
  // Success: open modal for the correct survey
  let surveyIdx = -1;
  for (let i = 0; i < SURVEY_DATA.length; i++) {
    if (SURVEY_DATA[i].id == surveyId) { surveyIdx = i; break; }
  }
  
  // Fallback if ID lookup fails
  if (surveyIdx === -1) surveyIdx = index % SURVEY_DATA.length;
  
  if (typeof openSurveyModal === 'function') openSurveyModal(surveyIdx);
};

// UI updater for question cards
function updateQuestionUI() {
  const completedArr = getCompletedQuestionCards();
  const currentXP = parseInt(localStorage.getItem('earnova_xp')) || 0;
  const limit = getDailyQuestionLimit(currentXP);
  const answeredToday = checkDailyQuestionLimit();
  const isLimitReached = answeredToday >= limit;
  
  const cards = document.querySelectorAll('.task-card[id^="q-card-"]');
  
  cards.forEach(card => {
    const surveyId = card.getAttribute('data-survey-id');
    const btn = card.querySelector('button');
    
    // Reset state first
    card.classList.remove('completed');
    card.style.opacity = '';
    card.style.cursor = '';
    if (btn) {
      btn.disabled = false;
      btn.innerText = 'Perform Task';
      btn.style.opacity = '';
      btn.style.cursor = '';
    }
    
    // Check Completed State
    if (completedArr.includes(surveyId)) {
      card.classList.add('completed');
      card.style.opacity = '0.5';
      card.style.cursor = 'not-allowed';
      if (btn) {
        btn.innerText = 'Completed';
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      }
      return;
    }
    
    // Check Daily Limit State
    if (isLimitReached) {
      card.classList.add('completed'); 
      card.style.opacity = '0.5';
      card.style.cursor = 'not-allowed';
      if (btn) {
        btn.innerText = 'Daily Limit';
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      }
    }
  });
}

// Call updateQuestionUI on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', updateQuestionUI);
} else {
  updateQuestionUI();
}

// Hook: after survey reward is claimed, increment and update UI
(function() {
  if (!window._questionLimitPatched) {
    const origMark = window.markQuestionCardCompleted;
    window.markQuestionCardCompleted = function(survey) {
      if (origMark) origMark.apply(this, arguments);
      incrementDailyQuestion();
      updateQuestionUI();
    };
    window._questionLimitPatched = true;
  }
})();

// Earnova: payment-gated auth and profile population
(function(){
  'use strict';

  function getAccounts(){
    return JSON.parse(localStorage.getItem('accounts') || '[]');
  }

  function saveAccounts(accounts){
    localStorage.setItem('accounts', JSON.stringify(accounts));
  }

  let signupForm = document.getElementById('signup-form');
  let loginForm = document.getElementById('login-form');
  let paymentModal = document.getElementById('payment-modal');
  let paystackPayBtn = document.getElementById('paystack-pay-btn');

  let tempAccount = null;

  function replaceWithClone(el){
    if(!el || !el.parentNode) return el;
    const clone = el.cloneNode(true);
    el.parentNode.replaceChild(clone, el);
    return clone;
  }

  function showPaymentModalFor(account){
    tempAccount = Object.assign({}, account, { paymentCompleted: false });
    const details = document.querySelector('.payment-details');
    if(details){
      details.innerHTML = `
        <div class="payment-row"><span class="payment-label">Amount:</span><span class="payment-value" style="color: var(--secondary-orange);">₦3,000.00</span></div>
      `;
    }
    if(paymentModal) paymentModal.classList.add('active');
  }

  function closePaymentModal(){
    if(paymentModal) paymentModal.classList.remove('active');
    tempAccount = null;
  }

  function initPaystackForTempAccount(){
    if(!tempAccount) return;
    if(typeof PaystackPop === 'undefined'){
      closePaymentModal();
      return;
    }

    const handler = PaystackPop.setup({
      key: PAYSTACK_PUBLIC_KEY,
      email: tempAccount.email,
      amount: 300000, // ₦3,000 in kobo
      currency: 'NGN',
      callback: function(response){
        tempAccount.paymentCompleted = true;
        addPaidAccount(tempAccount);
        try{ sessionStorage.setItem('currentUser', JSON.stringify(tempAccount)); }catch(e){}
        closePaymentModal();
        alert('Payment successful! Your account is now activated.');
        if(typeof toggleView === 'function'){
          toggleView('login');
        } else {
          window.location.href = 'login.html';
        }
      },
      onClose: function(){
        closePaymentModal();
      }
    });
    handler.openIframe();
  }
  
  function addPaidAccount(account){
    const accounts = getAccounts();
    const exists = accounts.some(a => a.email === account.email);
    if(!exists){
      accounts.push(account);
      saveAccounts(accounts);
    }
  }

  window.resetToLogin = function(){
    closePaymentModal();
    if(typeof toggleView === 'function') toggleView('login');
    tempAccount = null;
  };

  function handleSignupSubmit(e){
    e.preventDefault();
    const name = (document.getElementById('reg-name') || {}).value || '';
    const email = (document.getElementById('reg-email') || {}).value || '';
    const password = (document.getElementById('reg-pass') || {}).value || '';
    const confirm = (document.getElementById('reg-confirm') || {}).value || '';

    if(name.trim().length === 0) { showFieldError('reg-name','reg-name-error'); return; }
    if(!isValidEmail(email)) { showFieldError('reg-email','reg-email-error'); return; }
    if(password.length < 6) { showFieldError('reg-pass','reg-pass-error'); return; }
    if(password !== confirm) { showFieldError('reg-confirm','reg-confirm-error'); return; }

    const account = { name: name.trim(), email: email.trim().toLowerCase(), password: password, paymentCompleted: false };
    showPaymentModalFor(account);
  }

  function showFieldError(inputId, msgId){
    const input = document.getElementById(inputId);
    const msg = document.getElementById(msgId);
    if(input) input.classList.add('error');
    if(msg) msg.classList.add('visible');
  }

  function isValidEmail(email){
    return String(email).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);
  }

  function handleLoginSubmit(e){
    e.preventDefault();
    const email = (document.getElementById('login-email') || {}).value || '';
    const password = (document.getElementById('login-pass') || {}).value || '';

    if(!isValidEmail(email)) { showFieldError('login-email','login-email-error'); return; }

    const accounts = getAccounts();
    const user = accounts.find(a => a.email === email.trim().toLowerCase());
    if(!user || user.password !== password || user.paymentCompleted !== true){
      alert('You have not completed payment or account does not exist.');
      return;
    }

    try{ sessionStorage.setItem('currentUser', JSON.stringify(user)); }catch(e){}
    window.location.href = 'profile.html';
  }

  function populateProfileFromSession(){
    let current = null;
    try{ current = JSON.parse(sessionStorage.getItem('currentUser') || 'null'); }catch(e){ current = null; }
    if(!current) return;

    const dashTitle = document.querySelector('#dashboard .page-title');
    if(dashTitle) dashTitle.innerText = `Welcome back, ${current.name}`;

    const avatar = document.querySelector('.avatar');
    if(avatar){
      const initials = current.name.split(' ').map(s => s[0] || '').slice(0,2).join('').toUpperCase();
      avatar.innerText = initials;
    }

    // Profile form inputs in the #profile section
    const profileSection = document.getElementById('profile');
    if(profileSection){
      // Assuming inputs: Full Name, Email, Phone
      const nameInput = document.getElementById('profile-fullname');
      const emailInput = document.getElementById('profile-email');
      
      if(nameInput) nameInput.value = current.name;
      if(emailInput) emailInput.value = current.email;
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    signupForm = document.getElementById('signup-form');
    loginForm = document.getElementById('login-form');
    paymentModal = document.getElementById('payment-modal');
    paystackPayBtn = document.getElementById('paystack-pay-btn');

    if(signupForm){
      signupForm = replaceWithClone(signupForm);
      signupForm.addEventListener('submit', handleSignupSubmit);
    }

    if(loginForm){
      loginForm = replaceWithClone(loginForm);
      loginForm.addEventListener('submit', handleLoginSubmit);
    }

    if(paystackPayBtn){
      paystackPayBtn = replaceWithClone(paystackPayBtn);
      paystackPayBtn.addEventListener('click', function(ev){ ev.preventDefault(); if(tempAccount) initPaystackForTempAccount(); });
    }

    if(document.getElementById('profile')){
      populateProfileFromSession();
    }

    if(document.getElementById('video-modal-overlay')){
      initVideoModalSystem();
    }

    if(document.getElementById('survey-modal-overlay')){
      initSurveyModalSystem();
    }
  });

  // Daily Reset Countdown Timer & Auto Refresh
  function startDailyResetCountdown() {
    function updateCountdown() {
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setHours(24, 0, 0, 0); 
      
      let diff = tomorrow - now;
      
      if (diff <= 0) {
        localStorage.setItem('earnova_daily_watch_count', 0);
        localStorage.setItem('earnova_last_watch_date', new Date().toLocaleDateString());
        localStorage.removeItem('earnova_last_video_set');
        
        localStorage.setItem('earnova_daily_question_count', 0);
        localStorage.setItem('earnova_last_question_date', new Date().toLocaleDateString());
        localStorage.removeItem('earnova_last_question_set');
        
        localStorage.setItem('earnova_daily_website_count', 0);
        localStorage.setItem('earnova_last_website_date', new Date().toLocaleDateString());
        localStorage.removeItem('earnova_last_website_set');

        if (typeof refreshVideoTabForNewDay === 'function') refreshVideoTabForNewDay();
        if (typeof renderQuestionTabOnLoad === 'function') renderQuestionTabOnLoad();
        if (typeof renderWebsiteTabOnLoad === 'function') renderWebsiteTabOnLoad();
        
        diff = 24 * 60 * 60 * 1000;
      }
      
      const hours = Math.floor(diff / 1000 / 60 / 60);
      const mins = Math.floor((diff / 1000 / 60) % 60);
      const secs = Math.floor((diff / 1000) % 60);
      
      const el = document.getElementById('reset-countdown');
      if (el) {
        el.textContent = `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      if (document.getElementById('reset-countdown')) startDailyResetCountdown();
    });
  } else {
    if (document.getElementById('reset-countdown')) startDailyResetCountdown();
  }

})();


// ===================================================================
// VIDEO MODAL SYSTEM
// ===================================================================

function refreshVideoTabForNewDay() {
  const container = document.getElementById('video-task-list');
  if (!container) return;
  const completed = getCompletedVideos();
  const availableVideos = VIDEO_DATA.videos.filter(v => !completed.includes(v.videoId));
  const videosToShow = availableVideos.slice(0, 10);
  container.innerHTML = '';

  if (videosToShow.length === 0) {
    container.innerHTML = '<p style="padding:20px; color:var(--text-secondary);">No new videos available at the moment. Please check back later.</p>';
  } else {
    videosToShow.forEach((video, i) => {
      let rewardObj = getStoredRewardByVideo(video) || getVideoReward(i);
      let reward = rewardObj.amount;
      let xp = rewardObj.xp;
      
      let cardHtml = `
        <div class="task-card video-task-card" id="vid-${i}" data-video-index="${video.index}">
            <div class="task-header">
                <span class="task-type">Video Ad</span>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="task-reward">₦${reward}</span>
                    <span class="xp-badge">+${xp} XP</span>
                </div>
            </div>
            <div class="video-card-thumbnail" style="background-image: url('${video.thumbnail}');" onclick="openVideoModal(${video.index})" title="Click to watch video">
                <div class="video-card-play-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                </div>
            </div>
            <div class="task-body">
                <div class="task-title">${video.title}</div>
                <div class="task-meta">⏱ <span class="video-duration" data-video-index="${video.index}">Loading...</span> • HD</div>
                <div class="progress-container"><div class="progress-bar" id="prog-vid-${video.index}"></div></div>
                <button class="btn btn-primary" onclick="openVideoModal(${video.index})">Watch Now</button>
            </div>
        </div>`;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      container.appendChild(wrapper.firstElementChild);
    });
  }
  setTimeout(fetchAndPopulateDurations, 100);
  setTimeout(updateVideoCardStates, 200);
}

function renderVideoTabOnLoad() {
  const container = document.getElementById('video-task-list');
  if (!container) return;

  const currentXP = parseInt(localStorage.getItem('earnova_xp')) || 0;
  const limit = getDailyVideoLimit(currentXP); 
  const watchedToday = checkDailyLimit();
  const isLimitReached = watchedToday >= limit;

  const completed = getCompletedVideos();

  let videosToShow = [];
  if (isLimitReached) {
    let lastSet = localStorage.getItem('earnova_last_video_set');
    if (lastSet) {
      try {
        const lastSetArr = JSON.parse(lastSet);
        videosToShow = lastSetArr.map(id => VIDEO_DATA.videos.find(v => v.videoId === id)).filter(Boolean);
      } catch (e) { videosToShow = []; }
    }
    if (!videosToShow.length) {
      const availableVideos = VIDEO_DATA.videos.filter(v => !completed.includes(v.videoId));
      videosToShow = availableVideos.slice(0, 10);
    }
  } else {
    const availableVideos = VIDEO_DATA.videos.filter(v => !completed.includes(v.videoId));
    videosToShow = availableVideos.slice(0, 10);
    localStorage.setItem('earnova_last_video_set', JSON.stringify(videosToShow.map(v => v.videoId)));
  }

  container.innerHTML = '';
  if (videosToShow.length === 0) {
    container.innerHTML = '<p style="padding:20px; color:var(--text-secondary);">No new videos available at the moment. Please check back later.</p>';
  } else {
    videosToShow.forEach((video, i) => {
      let rewardObj = getStoredRewardByVideo(video) || getVideoReward(i);
      let reward = rewardObj.amount;
      let xp = rewardObj.xp;
      let cardHtml = `
        <div class="task-card video-task-card" id="vid-${i}" data-video-index="${video.index}">
            <div class="task-header">
                <span class="task-type">Video Ad</span>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="task-reward">₦${reward}</span>
                    <span class="xp-badge">+${xp} XP</span>
                </div>
            </div>
            <div class="video-card-thumbnail" style="background-image: url('${video.thumbnail}');" onclick="openVideoModal(${video.index})" title="Click to watch video">
                <div class="video-card-play-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                </div>
            </div>
            <div class="task-body">
                <div class="task-title">${video.title}</div>
                <div class="task-meta">⏱ <span class="video-duration" data-video-index="${video.index}">Loading...</span> • HD</div>
                <div class="progress-container"><div class="progress-bar" id="prog-vid-${video.index}"></div></div>
                <button class="btn btn-primary" onclick="openVideoModal(${video.index})">Watch Now</button>
            </div>
        </div>`;
      const wrapper = document.createElement('div');
      wrapper.innerHTML = cardHtml;
      container.appendChild(wrapper.firstElementChild);
    });
  }
  setTimeout(updateVideoCardStates, 100);
}

let VIDEO_DATA = { videos: [], currentIndex: null };

function getDailyVideoLimit(xp) {
    if (xp < 500) return 1; if (xp < 750) return 1; if (xp < 1125) return 1;
    if (xp < 1688) return 2; if (xp < 2532) return 2; if (xp < 3798) return 2;
    if (xp < 5697) return 2; if (xp < 8546) return 3; if (xp < 12819) return 3;
    if (xp < 19229) return 3; if (xp < 28844) return 4; if (xp < 43266) return 4;
    if (xp < 64899) return 5; if (xp < 97349) return 6; return 6;
}

function checkDailyLimit() {
    const today = new Date().toLocaleDateString();
    const storedDate = localStorage.getItem('earnova_last_watch_date');
    let watchedToday = parseInt(localStorage.getItem('earnova_daily_watch_count')) || 0;
    if (storedDate !== today) {
        watchedToday = 0;
        localStorage.setItem('earnova_last_watch_date', today);
        localStorage.setItem('earnova_daily_watch_count', 0);
    }
    return watchedToday;
}

function incrementDailyWatch() {
    let watchedToday = checkDailyLimit();
    watchedToday++;
    localStorage.setItem('earnova_daily_watch_count', watchedToday);
    localStorage.setItem('earnova_last_watch_date', new Date().toLocaleDateString());
}

async function fetchVideoData() {
  try {
    const response = await fetch('vids.json');
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const videos = await response.json();
    VIDEO_DATA.videos = videos.map((embedCode, index) => {
      const videoId = extractYouTubeId(embedCode);
      if (!videoId) return null;
      return {
        index: index, embedCode: embedCode, videoId: videoId,
        thumbnail: `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`,
        title: `Video Task #${index + 1}`
      };
    }).filter(v => v !== null);
    return VIDEO_DATA.videos;
  } catch (error) {
    const msgEl = document.querySelector('.video-modal-loading span');
    if (msgEl) msgEl.textContent = 'Error loading videos. Please refresh the page.';
    return [];
  }
}

function extractYouTubeId(iframeCode) {
  const match = iframeCode.match(/src="https:\/\/www\.youtube\.com\/embed\/([a-zA-Z0-9_-]+)"/);
  return match ? match[1] : null;
}

function getCompletedVideos() {
  try { return JSON.parse(localStorage.getItem('completedVideos') || '[]'); } catch (e) { return []; }
}
function setCompletedVideos(arr) {
  try { localStorage.setItem('completedVideos', JSON.stringify(arr)); } catch (e) {}
}
function markVideoCompleted(videoId) {
  if (!videoId) return;
  const arr = getCompletedVideos();
  if (!arr.includes(videoId)) { arr.push(videoId); setCompletedVideos(arr); }
}
function isVideoCompleted(videoId) { return getCompletedVideos().includes(videoId); }

function openVideoModal(videoIndex) {
  const video = VIDEO_DATA.videos.find(v => v.index === videoIndex);
  if (!video) return;

  if (isVideoCompleted(video.videoId)) {
    alert('You have already watched this video.');
    return;
  }
  const currentXP = parseInt(localStorage.getItem('earnova_xp')) || 0;
  const limit = getDailyVideoLimit(currentXP);
  // Get Effective Level (Paid) for alert display
  const effectiveLevel = typeof getEffectiveLevel === 'function' ? getEffectiveLevel() : 1;
  const watchedToday = checkDailyLimit();
  
  if (watchedToday >= limit) {
    alert(`Daily Limit Reached! Level ${effectiveLevel} allows ${limit} video(s) per day. Wait for the timer to reset.`);
    return;
  }
  
  VIDEO_DATA.currentIndex = video.index;
  let reward = getStoredRewardByVideo(video);
  if (!reward) {
    reward = getVideoReward(video.index); // Fallback logic same as before
    try { storeRewardForVideo(video, reward); } catch (e) {}
  }

  const overlay = document.getElementById('video-modal-overlay');
  const playerWrapper = document.getElementById('video-player-wrapper');
  const titleEl = document.getElementById('video-modal-title');
  const infoEl = document.getElementById('video-modal-info');
  const rewardEl = document.getElementById('video-modal-reward');

  titleEl.textContent = video.title;
  infoEl.textContent = `Video ${video.index + 1} of ${VIDEO_DATA.videos.length}`;
  rewardEl.textContent = `₦${reward.amount} + ${reward.xp} XP`;

  playerWrapper.innerHTML = '';
  const ytDivId = `yt-player-${video.videoId}`;
  const ytDiv = document.createElement('div');
  ytDiv.id = ytDivId;
  playerWrapper.appendChild(ytDiv);

  function onYouTubeReadyForModal() {
    if (!window.YT || !window.YT.Player) return setTimeout(onYouTubeReadyForModal, 100);
    let lastTime = 0; let skipped = false; let rewardGiven = false;
    const player = new YT.Player(ytDivId, {
      height: '360', width: '640', videoId: video.videoId,
      playerVars: { autoplay: 1, controls: 1, rel: 0, modestbranding: 1, enablejsapi: 1 },
      events: {
        onStateChange: function (event) {
          if (event.data === YT.PlayerState.PLAYING) {
            lastTime = player.getCurrentTime();
            skipped = false;
            player._interval = setInterval(function () {
              const current = player.getCurrentTime();
              if (current - lastTime > 2.5) skipped = true;
              lastTime = current;
            }, 1000);
          } else if (event.data === YT.PlayerState.ENDED) {
            clearInterval(player._interval);
            if (!skipped && !rewardGiven) {
              rewardGiven = true;
              try {
                window.addFunds && window.addFunds(reward.amount, 'Video', `Video Task #${video.index + 1}`, reward.xp);
                markVideoCompleted(video.videoId);
                incrementDailyWatch();
                updateVideoCardStates();
                alert('Reward added to your profile!');
              } catch (e) {}
            }
          } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.BUFFERING) {
            clearInterval(player._interval);
          }
        }
      }
    });
  }
  onYouTubeReadyForModal();
  overlay.classList.add('active');
  document.body.classList.add('modal-open');
  document.addEventListener('keydown', handleModalKeydown);
}

function closeVideoModal() {
  const overlay = document.getElementById('video-modal-overlay');
  const playerWrapper = document.getElementById('video-player-wrapper');
  document.removeEventListener('keydown', handleModalKeydown);
  overlay.classList.remove('active');
  document.body.classList.remove('modal-open');
  setTimeout(() => {
    playerWrapper.innerHTML = `<div class="video-modal-loading"><div class="video-modal-spinner"></div><span>Loading video...</span></div>`;
    VIDEO_DATA.currentIndex = null;
  }, 300);
  const videoCard = document.querySelector(`[data-video-index="${VIDEO_DATA.currentIndex}"]`);
  if (videoCard) { const btn = videoCard.querySelector('.btn'); if(btn && !btn.disabled) btn.focus(); }
}

function handleModalKeydown(e) { if (e.key === 'Escape') { closeVideoModal(); closeSurveyModal(); } }

function initVideoModalSystem() {
  fetchVideoData().then(() => {
    renderVideoTabOnLoad();
    updateVideoCardThumbnails();
    fetchAndPopulateDurations();
    const overlay = document.getElementById('video-modal-overlay');
    const closeBtn = document.getElementById('video-modal-close');
    closeBtn.addEventListener('click', closeVideoModal);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) closeVideoModal(); });
    const container = document.getElementById('video-modal-container');
    container.addEventListener('click', (e) => { e.stopPropagation(); });
    if (!window.YT || !window.YT.Player) {
      const tag = document.createElement('script'); tag.src = 'https://www.youtube.com/iframe_api'; document.head.appendChild(tag);
    }
    setTimeout(updateVideoCardStates, 300);
  });
}

function updateVideoCardStates() {
    const currentXP = parseInt(localStorage.getItem('earnova_xp')) || 0;
    const limit = getDailyVideoLimit(currentXP);
    const watchedToday = checkDailyLimit();
    const isLimitReached = watchedToday >= limit;

    document.querySelectorAll('.video-task-card').forEach((card) => {
        const index = parseInt(card.getAttribute('data-video-index'));
        const video = VIDEO_DATA.videos.find(v => v.index === index);
        if (!video) return;
        const btn = card.querySelector('.btn');
        const isDone = isVideoCompleted(video.videoId);
        if (isDone) {
            card.classList.add('completed'); card.style.opacity = '0.5'; card.style.cursor = 'not-allowed';
            if (btn) { btn.innerText = "Completed"; btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; }
        } else if (isLimitReached) {
            card.classList.add('completed'); card.style.opacity = '0.5'; card.style.cursor = 'not-allowed';
            if (btn) { btn.innerText = "Daily Limit"; btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; }
        } else {
            card.classList.remove('completed'); card.style.opacity = ''; card.style.cursor = '';
            if (btn) { btn.innerText = "Watch Now"; btn.style.opacity = ''; btn.style.cursor = ''; }
        }
    });
}

function updateVideoCardThumbnails() {
  document.querySelectorAll('.video-task-card').forEach((card) => {
      const index = parseInt(card.getAttribute('data-video-index'));
      const video = VIDEO_DATA.videos.find(v => v.index === index);
      if (video) {
        const thumbnail = card.querySelector('.video-card-thumbnail');
        if (thumbnail && video.thumbnail) {
          const img = new Image();
          img.onload = () => { thumbnail.style.backgroundImage = `url('${video.thumbnail}')`; };
          img.onerror = () => { thumbnail.style.backgroundImage = 'linear-gradient(135deg, #1E3A8A 0%, #F97316 100%)'; };
          img.src = video.thumbnail;
        }
      }
  });
}

function getVideoThumbnail(index) {
  if (index >= 0 && index < VIDEO_DATA.videos.length) return VIDEO_DATA.videos[index].thumbnail;
  return null;
}

function getVideoReward(videoIndex) {
  const vid = VIDEO_DATA.videos.find(v => v.index === videoIndex);
  if (!vid || typeof vid.duration !== 'number' || !isFinite(vid.duration) || vid.duration <= 0) {
    const rewards = [{ amount: 50, xp: 8 }, { amount: 75, xp: 10 }, { amount: 60, xp: 9 }, { amount: 80, xp: 11 }, { amount: 70, xp: 10 }, { amount: 90, xp: 12 }];
    return rewards[videoIndex % rewards.length] || { amount: 50, xp: 8 };
  }
  const categories = [
    { name: 'Small', minDur: 0.5, maxDur: 2, minPrice: 5,  maxPrice: 20,  minXP: 2,  maxXP: 5  },
    { name: 'Medium',minDur: 2,   maxDur: 10, minPrice: 15, maxPrice: 70,  minXP: 6,  maxXP: 15 },
    { name: 'Large', minDur: 10,  maxDur: 30, minPrice: 50, maxPrice: 200, minXP: 20, maxXP: 50 },
    { name: 'Very Large', minDur: 30, maxDur: 180, minPrice: 150, maxPrice: 400, minXP: 80, maxXP: 150 }
  ];
  const dur = vid.duration; 
  let cat = categories.find(c => dur >= c.minDur && dur < c.maxDur);
  if (!cat && dur >= 180) cat = categories[categories.length - 1];
  if (!cat) cat = categories[0];
  const denom = (cat.maxDur - cat.minDur) || 1;
  let duration_percent = (dur - cat.minDur) / denom;
  duration_percent = Math.max(0, Math.min(1, duration_percent));
  const basePrice = cat.minPrice + duration_percent * (cat.maxPrice - cat.minPrice);
  const baseXP = cat.minXP + duration_percent * (cat.maxXP - cat.minXP);
  const randPrice = (Math.random() * 2) - 1; 
  const randXP = (Math.random() - 0.5); 
  let price = basePrice + randPrice;
  let xp = baseXP + randXP;
  price = Math.max(cat.minPrice, Math.min(cat.maxPrice, price));
  xp = Math.max(cat.minXP, Math.min(cat.maxXP, xp));
  price = Math.round(price * 10) / 10;
  xp = Math.round(xp * 10) / 10;
  return { amount: price, xp: xp };
}

function getStoredRewardByVideo(video) {
  if (!video || !video.videoId) return null;
  try {
    const p = localStorage.getItem('videoPrice_' + video.videoId);
    const x = localStorage.getItem('videoXP_' + video.videoId);
    if (p === null || x === null) return null;
    const amount = parseFloat(p);
    const xp = parseFloat(x);
    if (isNaN(amount) || isNaN(xp)) return null;
    return { amount: amount, xp: xp };
  } catch (e) { return null; }
}

function storeRewardForVideo(video, reward) {
  if (!video || !video.videoId || !reward) return;
  try {
    localStorage.setItem('videoPrice_' + video.videoId, String(reward.amount));
    localStorage.setItem('videoXP_' + video.videoId, String(reward.xp));
  } catch (e) {}
}

function collectUsedRewardKeys() {
  const used = new Set();
  try {
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (!k) continue;
      if (k.indexOf('videoPrice_') === 0) {
        const vid = k.substring('videoPrice_'.length);
        const p = localStorage.getItem(k);
        const x = localStorage.getItem('videoXP_' + vid);
        if (p !== null && x !== null) {
          const ap = parseFloat(p);
          const ax = parseFloat(x);
          if (!isNaN(ap) && !isNaN(ax)) used.add(`${ap.toFixed(1)}|${ax.toFixed(1)}`);
        }
      }
    }
  } catch (e) {}
  return used;
}

function updateVideoCardRewards() {
  if (!VIDEO_DATA.videos || !VIDEO_DATA.videos.length) return;
  const used = collectUsedRewardKeys();
  document.querySelectorAll('.video-task-card').forEach((card) => {
    const index = parseInt(card.getAttribute('data-video-index'));
    const video = VIDEO_DATA.videos.find(v => v.index === index);
    if (!video) return;
    let reward = getStoredRewardByVideo(video);
    if (!reward && typeof video.duration === 'number' && isFinite(video.duration) && video.duration > 0) {
      let attempts = 0;
      do {
        reward = getVideoReward(index);
        const key = `${reward.amount.toFixed(1)}|${reward.xp.toFixed(1)}`;
        if (!used.has(key)) { used.add(key); try { storeRewardForVideo(video, reward); } catch (e) {} break; }
        attempts++;
        reward.amount = Math.round((reward.amount + (Math.random() * 0.6 - 0.3)) * 10) / 10;
        reward.xp = Math.round((reward.xp + (Math.random() * 0.3 - 0.15)) * 10) / 10;
      } while (attempts < 50);
      if (attempts >= 50) { try { storeRewardForVideo(video, reward); } catch (e) {} }
    }
    if (!reward) {
      reward = getVideoReward(index);
      const tmpKey = `${reward.amount.toFixed(1)}|${reward.xp.toFixed(1)}`;
      if (used.has(tmpKey)) {
        reward.amount = Math.round((reward.amount + 0.1) * 10) / 10;
        reward.xp = Math.round((reward.xp + 0.1) * 10) / 10;
      }
    }
    const rewardEl = card.querySelector('.task-reward');
    const xpEl = card.querySelector('.xp-badge');
    if (rewardEl) rewardEl.textContent = `₦${reward.amount}`;
    if (xpEl) xpEl.textContent = `+${reward.xp} XP`;
  });
}

function loadYouTubeAPI() {
  return new Promise((resolve) => {
    if (window.YT && window.YT.Player) return resolve();
    window.onYouTubeIframeAPIReady = function() { resolve(); };
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    document.head.appendChild(tag);
  });
}

function formatDuration(sec) {
  if (!isFinite(sec) || sec <= 0) return 'N/A';
  sec = Math.floor(sec);
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  if (h > 0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return `${m}:${String(s).padStart(2,'0')}`;
}

async function fetchAndPopulateDurations() {
  if (!VIDEO_DATA.videos || VIDEO_DATA.videos.length === 0) return;
  try {
    await loadYouTubeAPI();
    document.querySelectorAll('.video-task-card').forEach((card) => {
      const index = parseInt(card.getAttribute('data-video-index'));
      const video = VIDEO_DATA.videos.find(v => v.index === index);
      if (!video) return;
      const placeholder = card.querySelector('.video-duration');
      if (!placeholder) return;
      const divId = `yt-temp-player-${index}`;
      let div = document.getElementById(divId);
      if (!div) {
        div = document.createElement('div'); div.id = divId;
        div.style.width = '0px'; div.style.height = '0px'; div.style.overflow = 'hidden';
        div.style.position = 'absolute'; div.style.left = '-9999px';
        document.body.appendChild(div);
      }
      try {
        const player = new YT.Player(divId, {
          height: '0', width: '0', videoId: video.videoId,
          playerVars: { controls: 0, disablekb: 1, fs: 0, rel: 0 },
          events: {
            onReady: function(ev) {
              try {
                const dur = ev.target.getDuration();
                placeholder.textContent = formatDuration(dur);
                try { video.duration = (typeof dur === 'number' && isFinite(dur) && dur > 0) ? (dur / 60) : null; } catch (e) {}
                try { updateVideoCardRewards(); } catch (e) {}
              } catch (e) { placeholder.textContent = 'N/A'; try { video.duration = null; } catch (e) {} try { updateVideoCardRewards(); } catch (err) {} }
              try { ev.target.destroy(); } catch (e) {}
              if (div && div.parentNode) div.parentNode.removeChild(div);
            },
            onError: function() {
              placeholder.textContent = 'N/A'; try { video.duration = null; } catch (e) {} try { updateVideoCardRewards(); } catch (err) {}
              try { if (player && player.destroy) player.destroy(); } catch (e) {}
              if (div && div.parentNode) div.parentNode.removeChild(div);
            }
          }
        });
      } catch (err) { placeholder.textContent = 'N/A'; if (div && div.parentNode) div.parentNode.removeChild(div); }
    });
  } catch (err) { document.querySelectorAll('.video-duration').forEach(el => el.textContent = 'N/A'); }
}

// SURVEY MODAL SYSTEM
let SURVEY_DATA = [];
async function loadSurveyData() {
  try {
    const response = await fetch('questions.json');
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    SURVEY_DATA = await response.json();
    if (typeof renderQuestionTabOnLoad === "function") renderQuestionTabOnLoad();
  } catch (error) { console.error("Error loading questions.json:", error); }
}
loadSurveyData();

function renderQuestionTabOnLoad() {
    const container = document.getElementById('question-task-list');
    if (!container) return;
    if (!SURVEY_DATA || SURVEY_DATA.length === 0) return;
    const currentXP = parseInt(localStorage.getItem('earnova_xp')) || 0;
    const limit = getDailyQuestionLimit(currentXP);
    const answeredToday = checkDailyQuestionLimit();
    const isLimitReached = answeredToday >= limit;
    const completed = getCompletedQuestionCards();
    let toShow = [];
    if (isLimitReached) {
      let lastSet = localStorage.getItem('earnova_last_question_set');
      if (lastSet) {
        try {
          const lastSetArr = JSON.parse(lastSet);
          toShow = lastSetArr.map(id => SURVEY_DATA.find(q => q.id === id)).filter(Boolean);
        } catch (e) { toShow = []; }
      }
      if (!toShow.length) {
        const available = SURVEY_DATA.filter(q => !completed.includes(q.id));
        toShow = available.slice(0, 25);
      }
    } else {
      const available = SURVEY_DATA.filter(q => !completed.includes(q.id));
      toShow = available.slice(0, 25);
      localStorage.setItem('earnova_last_question_set', JSON.stringify(toShow.map(q => q.id)));
    }
    container.innerHTML = '';
    if (toShow.length === 0) {
      container.innerHTML = '<p style="padding:20px; color:var(--text-secondary);">No more questions available right now. Please check back later.</p>';
      return;
    }
    toShow.forEach((survey, index) => {
      let reward = null;
      if (typeof getStoredRewardByQuestionCard === "function") reward = getStoredRewardByQuestionCard(survey);
      if (!reward && typeof getQuestionCardReward === "function") reward = getQuestionCardReward(survey, index);
      if (!reward) reward = { amount: 150, xp: 10 };
      let btnText = 'Perform Task';
      let btnAttrs = `onclick=\"handleQuestionClick(${index}, '${survey.id}')\"`;
      let btnStyle = 'margin-top:auto';
      const cardHtml = `<div class=\"task-card\" id=\"q-card-${index}\" data-survey-id=\"${survey.id}\">\n<div class=\"task-header\">\n<span class=\"task-type\">Survey</span>\n<div style=\"display: flex; gap: 8px; align-items: center;\">\n<span class=\"task-reward\">₦${reward.amount}</span>\n<span class=\"xp-badge\">+${reward.xp} XP</span>\n</div>\n</div>\n<div class=\"task-body\">\n<div class=\"task-title\">${survey.title}</div>\n<p style=\"font-size:12px; color:var(--text-secondary); margin-bottom:12px;\">Complete this survey to earn rewards.</p>\n<button class=\"btn btn-primary\" style=\"${btnStyle}\" ${btnAttrs}>${btnText}</button>\n</div>\n</div>`;
      container.insertAdjacentHTML('beforeend', cardHtml);
    });
    updateQuestionUI();
}

const QUESTION_REWARD_CATEGORIES = [
  { name: 'Very Small', minQ: 1, maxQ: 3, minPrice: 5, maxPrice: 20, minXP: 2, maxXP: 8 },
  { name: 'Small', minQ: 4, maxQ: 7, minPrice: 20, maxPrice: 60, minXP: 8, maxXP: 25 },
  { name: 'Medium', minQ: 8, maxQ: 15, minPrice: 60, maxPrice: 120, minXP: 25, maxXP: 50 },
  { name: 'Large', minQ: 16, maxQ: 22, minPrice: 120, maxPrice: 180, minXP: 50, maxXP: 80 },
  { name: 'Very Large', minQ: 23, maxQ: 30, minPrice: 180, maxPrice: 250, minXP: 80, maxXP: 120 }
];

function getQuestionCardReward(survey, index) {
  if (!survey || !Array.isArray(survey.questions)) return { amount: 5, xp: 2 };
  const qCount = survey.questions.length;
  let cat = QUESTION_REWARD_CATEGORIES.find(c => qCount >= c.minQ && qCount <= c.maxQ);
  if (!cat) cat = QUESTION_REWARD_CATEGORIES[0];
  const denom = (cat.maxQ - cat.minQ) || 1;
  let qPercent = (qCount - cat.minQ) / denom;
  qPercent = Math.max(0, Math.min(1, qPercent));
  let basePrice = cat.minPrice + qPercent * (cat.maxPrice - cat.minPrice);
  let baseXP = cat.minXP + qPercent * (cat.maxXP - cat.minXP);
  const dec = ((index + 1) * 0.01) + (qCount * 0.001);
  let price = basePrice + dec; let xp = baseXP + dec;
  price = Math.max(cat.minPrice, Math.min(cat.maxPrice, price));
  xp = Math.max(cat.minXP, Math.min(cat.maxXP, xp));
  price = Math.round(price * 100) / 100; xp = Math.round(xp * 100) / 100;
  return { amount: price, xp: xp };
}

function getStoredRewardByQuestionCard(survey) {
  if (!survey || !survey.id) return null;
  try {
    const p = localStorage.getItem('questionPrice_' + survey.id);
    const x = localStorage.getItem('questionXP_' + survey.id);
    if (p === null || x === null) return null;
    const amount = parseFloat(p);
    const xp = parseFloat(x);
    if (isNaN(amount) || isNaN(xp)) return null;
    return { amount: amount, xp: xp };
  } catch (e) { return null; }
}

function storeRewardForQuestionCard(survey, reward) {
  if (!survey || !survey.id || !reward) return;
  try {
    localStorage.setItem('questionPrice_' + survey.id, String(reward.amount));
    localStorage.setItem('questionXP_' + survey.id, String(reward.xp));
  } catch (e) {}
}

function updateQuestionCardRewards() {
  if (!Array.isArray(SURVEY_DATA) || !SURVEY_DATA.length) return;
  SURVEY_DATA.forEach((survey, index) => {
    let reward = getStoredRewardByQuestionCard(survey);
    if (!reward) {
      reward = getQuestionCardReward(survey, index);
      storeRewardForQuestionCard(survey, reward);
    }
  });
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', updateQuestionCardRewards);
} else {
  updateQuestionCardRewards();
}

function getCompletedQuestionCards() {
  try { return JSON.parse(localStorage.getItem('completedQuestionCards')) || []; } catch (e) { return []; }
}
function setCompletedQuestionCards(arr) {
  localStorage.setItem('completedQuestionCards', JSON.stringify(arr));
}
function isQuestionCardCompleted(survey) {
  if (!survey || !survey.id) return false;
  const arr = getCompletedQuestionCards();
  return arr.includes(survey.id);
}
function markQuestionCardCompleted(survey) {
  if (!survey || !survey.id) return;
  const arr = getCompletedQuestionCards();
  if (!arr.includes(survey.id)) { arr.push(survey.id); setCompletedQuestionCards(arr); }
  var card = document.querySelector(`.task-card[data-survey-id="${survey.id}"]`);
  if (card) {
    card.classList.add('completed'); card.style.opacity = '0.5'; card.style.cursor = 'not-allowed';
    var btn = card.querySelector('button');
    if (btn) {
      btn.textContent = 'Completed'; btn.removeAttribute('disabled'); btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed';
      btn.onclick = function() { alert('You have already answered this question.'); };
    }
  }
}

window.openSurveyModal = function(index) {
  if (index < 0 || index >= SURVEY_DATA.length) return;
  const survey = SURVEY_DATA[index];
  const overlay = document.getElementById('survey-modal-overlay');
  const title = document.getElementById('survey-modal-title');
  const formContent = document.getElementById('survey-form-content');
  title.innerText = survey.title;
  formContent.innerHTML = '';
  survey.questions.forEach(q => { formContent.innerHTML += renderFormInput(q); });
  let footer = document.querySelector('.survey-modal-footer');
  if (footer) {
    footer.innerHTML = '';
    if (!isQuestionCardCompleted(survey)) {
      const btn = document.createElement('button');
      btn.className = 'btn btn-primary'; btn.textContent = 'Get Rewards';
      btn.onclick = function() {
        let allFilled = true;
        for (let i = 0; i < survey.questions.length; i++) {
          const q = survey.questions[i];
          let inputName = `q_${q.id}`;
          if (q.type === 'checkbox') inputName += '[]';
          const els = document.querySelectorAll(`[name="${inputName}"]`);
          if (!els || els.length === 0) { allFilled = false; break; }
          const type = (els[0].type || '').toLowerCase();
          if (type === 'checkbox' || type === 'radio') {
            let checked = false; els.forEach(e => { if (e.checked) checked = true; });
            if (!checked) { allFilled = false; break; }
          } else if (type === 'select-one') {
            if (!els[0].value || els[0].value === '') { allFilled = false; break; }
          } else {
            let filled = false; els.forEach(e => { if (e.value && e.value.trim() !== '') filled = true; });
            if (!filled) { allFilled = false; break; }
          }
        }
        if (!allFilled) { alert('You have not completed the form. Please answer all questions before claiming your reward.'); return; }
        if (isQuestionCardCompleted(survey)) { alert('You have already claimed this reward.'); return; }
        let reward = null;
        if (typeof getStoredRewardByQuestionCard === 'function') reward = getStoredRewardByQuestionCard(survey);
        if (!reward && typeof getQuestionCardReward === 'function') reward = getQuestionCardReward(survey, index);
        if (!reward) reward = { amount: 150, xp: 10 };
        if (typeof addFunds === 'function') { addFunds(reward.amount, 'Survey', survey.title, reward.xp); } 
        else {
          let bal = parseFloat(localStorage.getItem('earnova_balance')) || 0;
          let xp = parseInt(localStorage.getItem('earnova_xp')) || 0;
          bal += reward.amount; xp += reward.xp;
          localStorage.setItem('earnova_balance', bal); localStorage.setItem('earnova_xp', xp);
        }
        markQuestionCardCompleted(survey);
        window.closeSurveyModal();
      };
      footer.appendChild(btn);
    } else {
      const doneMsg = document.createElement('div');
      doneMsg.textContent = 'You have already completed this survey and claimed your reward.';
      doneMsg.style.color = 'var(--success)'; doneMsg.style.fontWeight = 'bold';
      footer.appendChild(doneMsg);
    }
  }
  overlay.classList.add('active');
  document.body.classList.add('modal-open');
};

window.closeSurveyModal = function() {
  const overlay = document.getElementById('survey-modal-overlay');
  overlay.classList.remove('active');
  document.body.classList.remove('modal-open');
};

function renderFormInput(q) {
  let inputHtml = '';
  switch(q.type) {
    case 'text': case 'number':
      inputHtml = `<input type="${q.type}" class="survey-input" placeholder="${q.placeholder || ''}" name="q_${q.id}">`; break;
    case 'textarea':
      inputHtml = `<textarea class="survey-textarea" placeholder="${q.placeholder || ''}" name="q_${q.id}"></textarea>`; break;
    case 'select':
      const options = q.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
      inputHtml = `<select class="survey-select" name="q_${q.id}"><option value="" disabled selected>Select an option</option>${options}</select>`; break;
    case 'radio':
      inputHtml = `<div class="survey-radio-group">`;
      q.options.forEach(opt => {
        const id = `q_${q.id}_${opt.replace(/\s+/g, '_')}`;
        inputHtml += `<label class="survey-option-label" for="${id}"><input type="radio" class="survey-option-input" name="q_${q.id}" id="${id}" value="${opt}">${opt}</label>`;
      });
      inputHtml += `</div>`; break;
    case 'checkbox':
      inputHtml = `<div class="survey-checkbox-group">`;
      q.options.forEach(opt => {
        const id = `q_${q.id}_${opt.replace(/\s+/g, '_')}`;
        inputHtml += `<label class="survey-option-label" for="${id}"><input type="checkbox" class="survey-option-input" name="q_${q.id}[]" id="${id}" value="${opt}">${opt}</label>`;
      });
      inputHtml += `</div>`; break;
  }
  return `<div class="survey-form-group"><label class="survey-question-label">${q.id}. ${q.question}</label>${inputHtml}</div>`;
}

function initSurveyModalSystem() {
  const overlay = document.getElementById('survey-modal-overlay');
  const container = document.getElementById('survey-modal-container');
  overlay.addEventListener('click', (e) => { if (e.target === overlay) closeSurveyModal(); });
  container.addEventListener('click', (e) => { e.stopPropagation(); });
}

// WEBSITE TASK SYSTEM
function getDailyWebsiteLimit(xp) {
  if (xp < 500) return 1; if (xp < 750) return 2; if (xp < 1125) return 3;
  if (xp < 1688) return 5; if (xp < 2532) return 5; if (xp < 3798) return 5;
  if (xp < 5697) return 7; if (xp < 8546) return 9; if (xp < 12819) return 10;
  if (xp < 19229) return 10; if (xp < 28844) return 12; if (xp < 43266) return 13;
  if (xp < 64899) return 15; if (xp < 97349) return 17; return 20;
}

function checkDailyWebsiteLimit() {
  const today = new Date().toLocaleDateString();
  const storedDate = localStorage.getItem('earnova_last_website_date');
  let visitedToday = parseInt(localStorage.getItem('earnova_daily_website_count')) || 0;
  if (storedDate !== today) {
    visitedToday = 0;
    localStorage.setItem('earnova_last_website_date', today);
    localStorage.setItem('earnova_daily_website_count', 0);
  }
  return visitedToday;
}

function incrementDailyWebsite() {
  let visitedToday = checkDailyWebsiteLimit();
  visitedToday++;
  localStorage.setItem('earnova_daily_website_count', visitedToday);
  localStorage.setItem('earnova_last_website_date', new Date().toLocaleDateString());
}

async function renderWebsiteTabOnLoad() {
    const container = document.getElementById('website-task-list');
    if (!container) return;
    let websites = [];
    try {
        const response = await fetch('websites.json');
        if (!response.ok) throw new Error('Failed to load website data');
        const data = await response.json();
        websites = data;
    } catch (error) { container.innerHTML = '<p style="padding:20px; color:var(--text-secondary);">Unable to load websites.</p>'; return; }
    
    container.innerHTML = '';
    const completedWebsites = JSON.parse(localStorage.getItem('completedWebsites') || '[]');
    const currentXP = parseInt(localStorage.getItem('earnova_xp')) || 0;
    const limit = getDailyWebsiteLimit(currentXP);
    const visitedToday = checkDailyWebsiteLimit();
    const isLimitReached = visitedToday >= limit;

    let toShow = [];
    if (isLimitReached) {
        let lastSet = localStorage.getItem('earnova_last_website_set');
        if (lastSet) {
            try {
                const lastSetUrls = JSON.parse(lastSet);
                toShow = websites.filter(site => lastSetUrls.includes(site.link));
            } catch(e) { toShow = []; }
        }
        if (!toShow.length) {
             const available = websites.filter(site => !completedWebsites.includes(site.link));
             toShow = available.slice(0, 20);
        }
    } else {
        const available = websites.filter(site => !completedWebsites.includes(site.link));
        toShow = available.slice(0, 20);
        localStorage.setItem('earnova_last_website_set', JSON.stringify(toShow.map(s => s.link)));
    }

    if (toShow.length === 0) {
        container.innerHTML = '<p style="padding:20px; color:var(--text-secondary);">No more websites available right now. Please check back later.</p>';
        return;
    }

    const activeTaskStr = localStorage.getItem('earnova_active_web_task');
    let activeTask = activeTaskStr ? JSON.parse(activeTaskStr) : null;
    const categories = [
      { name: 'Very Small', min: 5, max: 30, minPrice: 1, maxPrice: 3, minXP: 1, maxXP: 3 },
      { name: 'Small', min: 30, max: 120, minPrice: 3, maxPrice: 8, minXP: 3, maxXP: 8 },
      { name: 'Medium', min: 120, max: 600, minPrice: 8, maxPrice: 25, minXP: 8, maxXP: 20 },
      { name: 'Large', min: 600, max: 1800, minPrice: 25, maxPrice: 60, minXP: 20, maxXP: 40 },
      { name: 'Very Large', min: 1800, max: 3000, minPrice: 60, maxPrice: 100, minXP: 40, maxXP: 60 }
    ];

    function getStoredWebsiteReward(link) {
      try { const all = JSON.parse(localStorage.getItem('website_rewards') || '{}'); return all[link] || null; } catch (e) { return null; }
    }
    function storeWebsiteReward(link, price, xp) {
      try { const all = JSON.parse(localStorage.getItem('website_rewards') || '{}'); all[link] = { price, xp }; localStorage.setItem('website_rewards', JSON.stringify(all)); } catch (e) {}
    }

    toShow.forEach((site, index) => {
      let reward = getStoredWebsiteReward(site.link);
      let price, xp;
      if (reward) { price = reward.price; xp = reward.xp; } else {
        let cat = categories.find(c => site.seconds >= c.min && site.seconds <= c.max);
        if (!cat) cat = categories[0];
        const durationPercent = (site.seconds - cat.min) / (cat.max - cat.min);
        price = cat.minPrice + durationPercent * (cat.maxPrice - cat.minPrice);
        xp = cat.minXP + durationPercent * (cat.maxXP - cat.minXP);
        price = Math.max(cat.minPrice, Math.min(cat.maxPrice, price));
        xp = Math.max(cat.minXP, Math.min(cat.maxXP, xp));
        price = Math.round(price * 10) / 10; xp = Math.round(xp * 10) / 10;
        price = Math.min(100, Math.max(0.5, price)); xp = Math.min(60, Math.max(1, xp));
        storeWebsiteReward(site.link, price, xp);
      }

      const isCompleted = completedWebsites.includes(site.link);
      let btnAttrs = `onclick="initiateWebsiteTask('${site.link}', ${site.seconds}, ${price}, ${xp}, 'web-btn-${index}')"`;
      let btnText = "Visit Site";
      let cardStyle = "";
      let btnStyle = "margin-top:auto";

      if (isCompleted) {
        btnText = "Completed"; btnAttrs = `onclick="alert('You have already visited this website.')"`;
        cardStyle = "opacity:0.5; cursor:not-allowed;"; btnStyle += "; opacity:0.5; cursor:not-allowed;";
      } else if (isLimitReached) {
        btnText = "Daily Limit"; 
        // Use global level logic if available
        const lvl = typeof getLevel === 'function' ? getLevel(currentXP) : 1;
        btnAttrs = `onclick="alert('Daily Website Limit Reached! Level ${lvl} allows ${limit} websites per day.')"`;
        cardStyle = "opacity:0.5; cursor:not-allowed;"; btnStyle += "; opacity:0.5; cursor:not-allowed;";
      } else if (activeTask && activeTask.url === site.link) {
          btnText = "Visit in Progress..."; btnAttrs = `onclick="alert('This task is currently active. Please switch tabs to continue the timer.')"`;
      }
      const completedClass = isCompleted || isLimitReached ? 'completed' : '';
      const cardHtml = `<div class="task-card ${completedClass}" style="${cardStyle}" data-website-link="${site.link}">
        <div class="task-header"><span class="task-type">Website Visit</span><div style="display: flex; gap: 8px; align-items: center;"><span class="task-reward">₦${price}</span><span class="xp-badge">+${xp} XP</span></div></div>
        <div class="task-body"><div class="task-title">${site.title}</div><div class="task-meta">⏱ ${site.seconds} Seconds Required</div><button id="web-btn-${index}" class="btn btn-primary" style="${btnStyle}" ${btnAttrs}>${btnText}</button></div></div>`;
      container.insertAdjacentHTML('beforeend', cardHtml);
    });
}

function initiateWebsiteTask(url, seconds, reward, xp, btnId) {
    const currentXP = parseInt(localStorage.getItem('earnova_xp')) || 0;
    const limit = getDailyWebsiteLimit(currentXP);
    const visitedToday = checkDailyWebsiteLimit();
    if (visitedToday >= limit) {
        const lvl = typeof getLevel === 'function' ? getLevel(currentXP) : 1;
        alert(`Daily Website Limit Reached! Level ${lvl} allows ${limit} websites per day.`);
        return;
    }
    if (localStorage.getItem('earnova_active_web_task')) {
        alert("You already have a website task running. Please complete or cancel it first."); return;
    }
    window.open(url, '_blank');
    const task = { url: url, seconds: seconds, reward: reward, xp: xp, startTime: Date.now(), targetTime: Date.now() + (seconds * 1000) };
    localStorage.setItem('earnova_active_web_task', JSON.stringify(task));
    const btn = document.getElementById(btnId);
    if (btn) { btn.innerText = "Visit in Progress..."; btn.onclick = function() { alert('Task is running. Switch tabs to continue timer.'); }; }
}

function checkWebsiteTaskStatus() {
    const taskStr = localStorage.getItem('earnova_active_web_task');
    if (!taskStr) return;
    const task = JSON.parse(taskStr);
    const now = Date.now();
    if (now >= task.targetTime) {
        if (typeof addFunds === 'function') { addFunds(task.reward, 'Website Visit', `Visit to ${task.url}`, task.xp); }
        const completedWebsites = JSON.parse(localStorage.getItem('completedWebsites') || '[]');
        if (!completedWebsites.includes(task.url)) { completedWebsites.push(task.url); localStorage.setItem('completedWebsites', JSON.stringify(completedWebsites)); }
        incrementDailyWebsite();
        localStorage.removeItem('earnova_active_web_task');
        alert("You have claimed your reward!");
        renderWebsiteTabOnLoad();
    } else {
        localStorage.removeItem('earnova_active_web_task');
        alert("You have come back too early! You have not completed your stay on the site. Therefore you will not claim your reward.");
        renderWebsiteTabOnLoad();
    }
}

window.addEventListener('load', () => { checkWebsiteTaskStatus(); });
document.addEventListener('visibilitychange', () => { if (!document.hidden) { checkWebsiteTaskStatus(); } });
</script>
</body>
</html>